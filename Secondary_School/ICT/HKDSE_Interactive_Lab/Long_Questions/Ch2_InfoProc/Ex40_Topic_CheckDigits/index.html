<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HKDSE ICT Ch2 - Check Digit Laboratory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Noto+Sans+TC:wght@400;700&family=Fira+Code:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans TC", "Inter", sans-serif;
        background-color: #0f172a;
        color: #e2e8f0;
      }
      .font-mono {
        font-family: "Fira Code", monospace;
      }
    </style>
  </head>
  <body class="min-h-screen p-4 md:p-8 flex flex-col items-center">
    <div id="root" class="w-full max-w-5xl"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;

      const createLucideIcon = (name) => {
        const iconData = window.lucide?.icons[name];
        if (!iconData) return (props) => <span {...props}>?</span>;
        const toCamel = (s) => s.replace(/-./g, (x) => x[1].toUpperCase());
        const formatAttrs = (a) => {
          const n = {};
          for (const k in a) {
            if (k === "class") n.className = a[k];
            else if (k.includes("-")) n[toCamel(k)] = a[k];
            else n[k] = a[k];
          }
          return n;
        };
        return ({ color, size, strokeWidth, className, ...props }) =>
          React.createElement(
            "svg",
            {
              width: size || 24,
              height: size || 24,
              stroke: color || "currentColor",
              strokeWidth: strokeWidth || 2,
              fill: "none",
              strokeLinecap: "round",
              strokeLinejoin: "round",
              className: `lucide lucide-${name.toLowerCase()} ${
                className || ""
              }`.trim(),
              xmlns: "http://www.w3.org/2000/svg",
              viewBox: "0 0 24 24",
              ...props,
            },
            iconData.map(([tag, attrs], i) =>
              React.createElement(tag, { ...formatAttrs(attrs), key: i })
            )
          );
      };

      const Icon = ({ name, ...props }) => {
        const Cmp = useMemo(() => createLucideIcon(name), [name]);
        return <Cmp {...props} />;
      };

      const App = () => {
        const [method, setMethod] = useState("isbn10");
        const [input, setInput] = useState("");

        // Calculation Logic
        const result = useMemo(() => {
          let steps = [];
          let checkDigit = "?";
          let isValid = false;
          let sum = 0;
          let weights = [];
          let digits = [];

          if (method === "isbn10") {
            // ISBN-10: 9 digits + check. Mod 11. Weights 10..2
            const clean = input.replace(/-/g, "").replace(/ /g, "");
            digits = clean
              .split("")
              .map((d) => parseInt(d))
              .filter((d) => !isNaN(d));
            if (digits.length > 9) digits = digits.slice(0, 9);
            weights = [10, 9, 8, 7, 6, 5, 4, 3, 2];

            for (let i = 0; i < Math.min(digits.length, 9); i++) {
              const prod = digits[i] * weights[i];
              sum += prod;
              steps.push({ d: digits[i], w: weights[i], p: prod });
            }

            if (digits.length === 9) {
              const remainder = sum % 11;
              const check = 11 - remainder;
              checkDigit =
                check === 10 ? "X" : check === 11 ? "0" : check.toString();
            }
          } else if (method === "isbn13") {
            // ISBN-13: 12 digits + check. Mod 10. Weights 1, 3
            const clean = input.replace(/-/g, "").replace(/ /g, "");
            digits = clean
              .split("")
              .map((d) => parseInt(d))
              .filter((d) => !isNaN(d));
            if (digits.length > 12) digits = digits.slice(0, 12);

            for (let i = 0; i < Math.min(digits.length, 12); i++) {
              const w = i % 2 === 0 ? 1 : 3;
              const prod = digits[i] * w;
              sum += prod;
              steps.push({ d: digits[i], w: w, p: prod });
              weights.push(w);
            }

            if (digits.length === 12) {
              const remainder = sum % 10;
              const check = (10 - remainder) % 10;
              checkDigit = check.toString();
            }
          } else if (method === "hkid") {
            // HKID: Prefix (1 or 2 chars) + 6 digits + Check. We assume 1 char prefix for simplicity or handle both.
            // Standard: 1 letter + 6 digits.
            // Logic: Letter A=10... Z=35. Weights 8 7 6 5 4 3 2.
            const clean = input
              .toUpperCase()
              .replace(/[\(\)]/g, "")
              .replace(/ /g, "");
            const match = clean.match(/^([A-Z])([0-9]{6})/);

            if (match) {
              const charCode = match[1].charCodeAt(0) - 55; // A(65)->10
              const nums = match[2].split("").map(Number);
              digits = [charCode, ...nums];
              weights = [8, 7, 6, 5, 4, 3, 2];

              for (let i = 0; i < digits.length; i++) {
                const prod = digits[i] * weights[i];
                sum += prod;
                steps.push({
                  d: i === 0 ? match[1] : digits[i],
                  val: digits[i],
                  w: weights[i],
                  p: prod,
                });
              }

              const remainder = sum % 11;
              const check = 11 - remainder;
              if (check === 11) checkDigit = "0";
              else if (check === 10) checkDigit = "A";
              else checkDigit = check.toString();
            }
          }

          return { steps, checkDigit, sum };
        }, [input, method]);

        return (
          <div className="space-y-6 w-full max-w-4xl animate-in fade-in zoom-in-95 duration-500">
            <header className="flex items-center gap-4 bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
              <div className="p-3 bg-indigo-600 rounded-xl">
                <Icon name="ShieldCheck" size={32} className="text-white" />
              </div>
              <div>
                <h1 className="text-2xl font-bold text-white">
                  Check Digit Calculator
                </h1>
                <p className="text-slate-400 text-sm">
                  HKDSE ICT Information Processing (Ch 2)
                </p>
              </div>
            </header>

            <div className="bg-slate-900/50 p-2 rounded-xl flex gap-2 border border-slate-700">
              {[
                { id: "isbn10", label: "ISBN-10", icon: "Book" },
                { id: "isbn13", label: "ISBN-13", icon: "Library" },
                { id: "hkid", label: "HKID (Alpha+6)", icon: "CreditCard" },
              ].map((m) => (
                <button
                  key={m.id}
                  onClick={() => {
                    setMethod(m.id);
                    setInput("");
                  }}
                  className={`flex-1 py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all ${
                    method === m.id
                      ? "bg-indigo-600 text-white shadow-lg"
                      : "text-slate-400 hover:bg-slate-800"
                  }`}
                >
                  <Icon name={m.icon} size={18} /> {m.label}
                </button>
              ))}
            </div>

            <div className="bg-slate-800 p-8 rounded-2xl border border-slate-700 shadow-xl">
              <div className="mb-8">
                <label className="block text-indigo-400 font-bold mb-2">
                  {method === "hkid"
                    ? "Enter HKID (e.g., K123456)"
                    : "Enter Digits (Without Check Digit)"}
                </label>
                <div className="flex gap-4">
                  <input
                    type="text"
                    value={input}
                    onChange={(e) => setInput(e.target.value.toUpperCase())}
                    maxLength={
                      method === "isbn13" ? 12 : method === "hkid" ? 7 : 9
                    }
                    className="flex-1 bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-2xl font-mono text-white tracking-widest focus:border-indigo-500 focus:outline-none"
                    placeholder={
                      method === "isbn13"
                        ? "978123..."
                        : method === "hkid"
                        ? "A123456"
                        : "0123..."
                    }
                  />
                  <div className="bg-slate-900 border border-slate-700 rounded-xl px-6 py-3 flex flex-col items-center justify-center min-w-[100px]">
                    <span className="text-xs text-slate-500 uppercase font-bold">
                      Check Digit
                    </span>
                    <span className="text-2xl font-bold text-indigo-400 font-mono">
                      {result.checkDigit}
                    </span>
                  </div>
                </div>
              </div>

              {result.steps.length > 0 && (
                <div className="bg-slate-900 rounded-xl p-6 border border-slate-700">
                  <h3 className="text-white font-bold mb-4 flex items-center gap-2">
                    <Icon name="Calculator" size={18} /> Calculation Steps
                  </h3>

                  <div className="flex flex-col gap-2">
                    {/* Row 1: Digits */}
                    <div className="flex gap-1 justify-center">
                      {result.steps.map((s, i) => (
                        <div
                          key={i}
                          className="w-10 text-center text-slate-300 font-mono text-lg"
                        >
                          {s.d}
                        </div>
                      ))}
                    </div>
                    {/* Row 2: Weights */}
                    <div className="flex gap-1 justify-center text-xs text-slate-500">
                      {result.steps.map((s, i) => (
                        <div key={i} className="w-10 text-center">
                          Ã—{s.w}
                        </div>
                      ))}
                    </div>
                    {/* Row 3: Products */}
                    <div className="flex gap-1 justify-center">
                      {result.steps.map((s, i) => (
                        <div
                          key={i}
                          className="w-10 text-center text-indigo-400 font-bold border-t border-slate-700 pt-1"
                        >
                          {s.p}
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="mt-6 pt-6 border-t border-slate-700 flex flex-col items-center gap-2">
                    <div className="text-slate-400 text-sm">
                      Sum of Products ={" "}
                      <span className="text-white font-bold text-lg">
                        {result.sum}
                      </span>
                    </div>
                    <div className="text-indigo-300 font-mono bg-indigo-900/20 px-4 py-2 rounded-lg border border-indigo-500/30">
                      {method === "isbn13"
                        ? `10 - (${result.sum} mod 10) = ${result.checkDigit}`
                        : `11 - (${result.sum} mod 11) = ${result.checkDigit}`}
                    </div>
                  </div>
                </div>
              )}
            </div>

            <div className="p-4 bg-indigo-900/20 border border-indigo-500/30 rounded-lg text-sm text-indigo-200 flex gap-2">
              <Icon name="Info" className="shrink-0" />
              <div>
                <strong>Algorithm Note:</strong>
                {method === "isbn10" &&
                  " ISBN-10 uses Modulo 11 check digit. Weights decrease from 10 to 2."}
                {method === "isbn13" &&
                  " ISBN-13 uses Modulo 10 check digit. Weights alternate between 1 and 3."}
                {method === "hkid" &&
                  " HKID uses Weighted Modulo 11. Letter A=10, B=11... Check Digit can be 'A' (10) or '0' (11)."}
              </div>
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
