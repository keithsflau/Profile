<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>HKDSE 2024 Q1: Data Integrity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      body {
        background-color: #0f172a;
        color: #e2e8f0;
        font-family: sans-serif;
      }
    </style>
  </head>
  <body class="p-4 flex justify-center min-h-screen">
    <div id="root" class="w-full max-w-4xl"></div>
    <script type="text/babel">
      const { useState } = React;
      const createLucideIcon = (name) => {
        const iconData = window.lucide?.icons[name];
        if (!iconData) return (props) => <span>?</span>;
        return ({ size, className, ...props }) =>
          React.createElement(
            "svg",
            {
              width: size || 24,
              height: size || 24,
              fill: "none",
              stroke: "currentColor",
              strokeWidth: 2,
              strokeLinecap: "round",
              strokeLinejoin: "round",
              className: `lucide lucide-${name.toLowerCase()} ${
                className || ""
              }`,
              viewBox: "0 0 24 24",
              ...props,
            },
            iconData.map(([tag, attrs], i) =>
              React.createElement(tag, { ...attrs, key: i })
            )
          );
      };
      const Icon = ({ name, ...p }) => {
        const C = createLucideIcon(name);
        return <C {...p} />;
      };

      const TEXT = {
        en: {
          title: "HKDSE 2024 Q1: Data Integrity",
          subtitle: "Database & Spreadsheet Concepts",
          scenario:
            "Scenario: A school database stores Student Records. Ensure data integrity.",
          table: "STUDENT Table",
          id: "Student ID (PK)",
          name: "Name",
          mark: "Mark (0-100)",
          classId: "Class ID (FK)",
          validate: "Validate Data",
          reset: "Reset Data",
          errEntity:
            "A. Entity Integrity Violation: Primary Key cannot be duplicate or empty.",
          errDomain:
            "B. Domain Integrity Violation: Mark must be between 0 and 100.",
          errRef:
            "C. Referential Integrity Violation: Class ID must exist in CLASS Table.",
          valid: "Data is Valid!",
          refTable: "Reference: CLASS Table",
          refContent: "Class IDs: 2A, 2B, 2C",
        },
        tc: {
          title: "HKDSE 2024 Q1: 數據完整性",
          subtitle: "數據庫與試算表概念",
          scenario: "情境：學校數據庫儲存學生記錄。確保數據完整性。",
          table: "學生表 (STUDENT)",
          id: "學生編號 (PK)",
          name: "姓名",
          mark: "分數 (0-100)",
          classId: "班別編號 (FK)",
          validate: "驗證數據",
          reset: "重置數據",
          errEntity: "A. 實體完整性違規：主鍵不能重複或為空。",
          errDomain: "B. 域完整性違規：分數必須在 0 到 100 之間。",
          errRef: "C. 參照完整性違規：班別編號必須存在於班別表中。",
          valid: "數據有效！",
          refTable: "參考：班別表 (CLASS)",
          refContent: "班別編號：2A, 2B, 2C",
        },
      };

      const INITIAL_DATA = [
        { id: "S101", name: "Alice", mark: 85, classId: "2A", error: null },
        { id: "S102", name: "Bob", mark: 105, classId: "2B", error: null }, // Domain Error
        { id: "S101", name: "Charlie", mark: 60, classId: "2A", error: null }, // Entity Error (Dupe S101)
        { id: "S104", name: "David", mark: 90, classId: "2D", error: null }, // Ref Error (2D not exist)
      ];

      const VALID_CLASSES = ["2A", "2B", "2C"];

      const App = () => {
        const [lang, setLang] = useState("en");
        const t = TEXT[lang];
        const [data, setData] = useState(INITIAL_DATA);

        const handleChange = (idx, field, val) => {
          const newData = [...data];
          newData[idx][field] = val;
          newData[idx].error = null; // Clear error on edit
          setData(newData);
        };

        const validate = () => {
          const newData = [...data];
          const ids = new Set();

          // First pass: Check Entity (ID)
          newData.forEach((d) => {
            if (ids.has(d.id)) d.error = "entity";
            else ids.add(d.id);
          });

          // Check others if no Entity error yet
          newData.forEach((d) => {
            if (d.error) return; // Skip if already flagged
            // Domain
            if (d.mark < 0 || d.mark > 100) d.error = "domain";
            // Referential
            else if (!VALID_CLASSES.includes(d.classId)) d.error = "ref";
          });

          setData(newData);
        };

        const reset = () => setData(INITIAL_DATA);

        const getErrorMsg = (code) => {
          if (code === "entity") return t.errEntity;
          if (code === "domain") return t.errDomain;
          if (code === "ref") return t.errRef;
          return "";
        };

        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center bg-slate-800 p-4 rounded-xl border border-slate-700">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-pink-600 rounded-lg">
                  <Icon name="ShieldAlert" className="text-white" />
                </div>
                <div>
                  <h1 className="text-xl font-bold text-white">{t.title}</h1>
                  <p className="text-slate-400 text-xs">{t.subtitle}</p>
                </div>
              </div>
              <button
                onClick={() => setLang((l) => (l === "en" ? "tc" : "en"))}
                className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white font-bold border border-slate-500"
              >
                {lang === "en" ? "中文" : "English"}
              </button>
            </div>

            <div className="bg-slate-900 border border-slate-700 rounded-xl p-6">
              <div className="flex justify-between items-start mb-6">
                <h2 className="text-white font-bold flex items-center gap-2">
                  <Icon name="Database" /> {t.table}
                </h2>
                <div className="bg-slate-800 p-2 rounded text-xs text-slate-400 border border-slate-600">
                  <div className="font-bold text-slate-300 mb-1">
                    {t.refTable}
                  </div>
                  {t.refContent}
                </div>
              </div>

              <div className="space-y-4">
                {data.map((row, i) => (
                  <div
                    key={i}
                    className={`grid grid-cols-12 gap-2 items-center p-3 rounded border ${
                      row.error
                        ? "bg-red-900/20 border-red-500"
                        : "bg-slate-800 border-slate-700"
                    }`}
                  >
                    <div className="col-span-3">
                      <label className="text-[10px] text-slate-400 font-bold block mb-1">
                        {t.id}
                      </label>
                      <input
                        type="text"
                        value={row.id}
                        onChange={(e) => handleChange(i, "id", e.target.value)}
                        className="w-full bg-slate-900 text-white p-1 rounded border border-slate-600 font-mono text-sm"
                      />
                    </div>
                    <div className="col-span-3">
                      <label className="text-[10px] text-slate-400 font-bold block mb-1">
                        {t.name}
                      </label>
                      <input
                        type="text"
                        value={row.name}
                        onChange={(e) =>
                          handleChange(i, "name", e.target.value)
                        }
                        className="w-full bg-slate-900 text-white p-1 rounded border border-slate-600 text-sm"
                      />
                    </div>
                    <div className="col-span-3">
                      <label className="text-[10px] text-slate-400 font-bold block mb-1">
                        {t.mark}
                      </label>
                      <input
                        type="number"
                        value={row.mark}
                        onChange={(e) =>
                          handleChange(i, "mark", parseInt(e.target.value))
                        }
                        className="w-full bg-slate-900 text-white p-1 rounded border border-slate-600 font-mono text-sm"
                      />
                    </div>
                    <div className="col-span-3">
                      <label className="text-[10px] text-slate-400 font-bold block mb-1">
                        {t.classId}
                      </label>
                      <input
                        type="text"
                        value={row.classId}
                        onChange={(e) =>
                          handleChange(i, "classId", e.target.value)
                        }
                        className="w-full bg-slate-900 text-white p-1 rounded border border-slate-600 font-mono text-sm uppercase"
                      />
                    </div>
                    {row.error && (
                      <div className="col-span-12 text-red-400 text-xs font-bold flex items-center gap-1 mt-1">
                        <Icon name="AlertCircle" size={12} />{" "}
                        {getErrorMsg(row.error)}
                      </div>
                    )}
                  </div>
                ))}
              </div>

              <div className="mt-8 flex justify-center gap-4">
                <button
                  onClick={reset}
                  className="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded font-bold"
                >
                  {t.reset}
                </button>
                <button
                  onClick={validate}
                  className="px-8 py-2 bg-pink-600 hover:bg-pink-500 text-white font-bold rounded shadow-lg flex items-center gap-2"
                >
                  <Icon name="CheckSquare" /> {t.validate}
                </button>
              </div>
            </div>
          </div>
        );
      };
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
