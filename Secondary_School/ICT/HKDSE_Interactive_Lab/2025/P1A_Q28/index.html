<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HKDSE 2025 Paper 1A Q28 - 流程圖追蹤器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans TC", sans-serif;
        background: #0f172a;
        color: #e2e8f0;
      }
      /* Flowchart overrides for paper style */
      .mermaid .node rect,
      .mermaid .node polygon,
      .mermaid .node circle,
      .mermaid .node path {
        fill: #ffffff;
        stroke: #000000;
        stroke-width: 2px;
      }
      .mermaid .edgePath .path {
        stroke: #000000 !important;
        stroke-width: 2px !important;
      }
      .mermaid .marker {
        fill: #000000 !important;
        stroke: #000000 !important;
      }
      .mermaid .nodeLabel {
        color: #000;
      }

      /* Active state overrides */
      /* Note: Mermaid classes sometimes apply to g elements or path/rect inside */
      g.activeNode > rect,
      g.activeNode > polygon,
      g.activeNode > circle,
      g.activeNode > path {
        fill: #fef3c7 !important;
        stroke: #f59e0b !important;
        stroke-width: 3px !important;
        filter: drop-shadow(0 0 5px #fbbf24);
      }
    </style>
  </head>
  <body class="min-h-screen p-4 md:p-8 flex flex-col items-center">
    <div id="root" class="w-full max-w-6xl"></div>
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // Initialize mermaid
      mermaid.initialize({
        startOnLoad: false,
        theme: "base",
        flowchart: {
          curve: "linear",
          padding: 20,
        },
        themeVariables: {
          primaryColor: "#ffffff",
          primaryBorderColor: "#000000",
          lineColor: "#000000",
          fontFamily: '"Noto Sans TC", sans-serif',
        },
      });

      const MermaidDiagram = ({ id, chartDefinition, activeStep }) => {
        const containerRef = useRef(null);

        useEffect(() => {
          if (containerRef.current) {
            const uniqueId = `${id}-${Date.now()}`;
            // Inject class for active step
            let highlightStyle = "";
            if (activeStep > 0) {
              highlightStyle = `\nclass N${activeStep} activeNode;`;
            }

            const finalChart = `
              ${chartDefinition}
              classDef activeNode fill:#fef3c7,stroke:#f59e0b,stroke-width:3px;
              classDef hidden width:0px,height:0px,opacity:0;
              classDef label font-weight:bold;
              ${highlightStyle}
            `;

            containerRef.current.innerHTML = "";
            try {
              mermaid.render(uniqueId, finalChart).then((result) => {
                containerRef.current.innerHTML = result.svg;
              });
            } catch (e) {
              console.error("Mermaid error:", e);
              // Retry once with a new ID if it fails (sometimes helps with cache)
            }
          }
        }, [id, chartDefinition, activeStep]);

        return (
          <div ref={containerRef} className="flex justify-center w-full" />
        );
      };

      const App = () => {
        const [m1Step, setM1Step] = useState(0);
        const [m2Step, setM2Step] = useState(0);
        const [m1State, setM1State] = useState({ N: 10, output: 0 });
        const [m2State, setM2State] = useState({ N: 10, output: 0 });
        const [isRunning, setIsRunning] = useState(false);
        const [finished, setFinished] = useState(false);
        const timerRef = useRef(null);

        const m1Chart = `
          flowchart TD
            N1((Start)) --> N2[/Input N/]
            N2 --> N3{N > 4?}
            N3 -- No --x End((End)):::hidden
            N3 -- Yes --> N4[/Output/]
            N4 --> N5[N ← N - 5]
            N5 --> N3
            
            linkStyle default stroke-width:2px,fill:none,stroke:black;
        `;

        const m2Chart = `
          flowchart TD
            N1((Start)) --> N2[/Input N/]
            N2 --> N3{N > 4?}
            N3 -- No --x End((End)):::hidden
            N3 -- Yes --> N4[N ← N - 5]
            N4 --> N5[/Output/]
            N5 --> N3
            
            linkStyle default stroke-width:2px,fill:none,stroke:black;
        `;

        const runTrace = () => {
          if (isRunning) return;
          setIsRunning(true);
          setFinished(false);
          setM1Step(0);
          setM2Step(0);
          setM1State({ N: 10, output: 0 });
          setM2State({ N: 10, output: 0 });

          const sequence = [
            // Step 1: Start
            {
              m1: { step: 1, N: 10, output: 0 },
              m2: { step: 1, N: 10, output: 0 },
            },
            // Step 2: Input N
            {
              m1: { step: 2, N: 10, output: 0 },
              m2: { step: 2, N: 10, output: 0 },
            },
            // Step 3: Check N > 4? (Yes for both)
            {
              m1: { step: 3, N: 10, output: 0 },
              m2: { step: 3, N: 10, output: 0 },
            },
            // Loop 1
            // M1: Output -> Calc
            {
              m1: { step: 4, N: 10, output: 1 },
              m2: { step: 4, N: 5, output: 0 },
            },
            {
              m1: { step: 5, N: 5, output: 1 },
              m2: { step: 5, N: 5, output: 1 },
            },

            // Back to Decision
            {
              m1: { step: 3, N: 5, output: 1 },
              m2: { step: 3, N: 5, output: 1 },
            },

            // Loop 2
            // M1: Output -> Calc
            {
              m1: { step: 4, N: 5, output: 2 },
              m2: { step: 4, N: 0, output: 1 },
            },
            {
              m1: { step: 5, N: 0, output: 2 },
              m2: { step: 5, N: 0, output: 2 },
            },

            // Back to Decision (N=0, fails)
            {
              m1: { step: 3, N: 0, output: 2 },
              m2: { step: 3, N: 0, output: 2 },
            },

            // End
            {
              m1: { step: 0, N: 0, output: 2 },
              m2: { step: 0, N: 0, output: 2 },
            },
          ];

          let i = 0;
          timerRef.current = setInterval(() => {
            if (i >= sequence.length) {
              clearInterval(timerRef.current);
              setIsRunning(false);
              setFinished(true);
              return;
            }
            if (sequence[i].m1) {
              setM1Step(sequence[i].m1.step);
              setM1State({
                N: sequence[i].m1.N,
                output: sequence[i].m1.output,
              });
            }
            if (sequence[i].m2) {
              setM2Step(sequence[i].m2.step);
              setM2State({
                N: sequence[i].m2.N,
                output: sequence[i].m2.output,
              });
            }
            i++;
          }, 1000);
        };

        return (
          <div className="space-y-6 w-full max-w-5xl mx-auto">
            <header className="text-center">
              <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-cyan-900/30 border border-cyan-500/30 text-cyan-400 font-bold mb-4">
                <span className="w-2 h-2 rounded-full bg-cyan-400 animate-pulse"></span>
                HKDSE 2025 Paper 1A Q28
              </div>

              <div className="bg-slate-800/80 p-6 rounded-2xl border border-slate-700 text-left mb-6">
                <h2 className="text-xl font-bold text-white mb-3">題目</h2>
                <p className="text-slate-300 mb-2">
                  假設 N = 10，兩部汽水機 M1 和 M2 各輸出多少罐汽水？
                </p>
                <p className="text-slate-400 text-sm">
                  M1: 先輸出，後計算 | M2: 先計算，後輸出
                </p>
              </div>
            </header>

            <div className="flex flex-wrap justify-center gap-8">
              <div className="text-center w-full md:w-[45%]">
                <div className="font-bold text-gray-400 text-lg mb-2">M1</div>
                <div className="bg-white p-4 rounded-lg w-full min-h-[400px] flex items-start justify-center overflow-hidden">
                  <MermaidDiagram
                    id="m1-chart"
                    chartDefinition={m1Chart}
                    activeStep={m1Step}
                  />
                </div>
                <div className="mt-4 bg-slate-800 p-3 rounded-lg">
                  <div className="text-sm text-slate-400">M1 狀態</div>
                  <div className="text-lg font-mono">
                    N = <span className="text-yellow-400">{m1State.N}</span> |
                    輸出 ={" "}
                    <span className="text-green-400">{m1State.output}</span>
                  </div>
                </div>
              </div>

              <div className="text-center w-full md:w-[45%]">
                <div className="font-bold text-gray-400 text-lg mb-2">M2</div>
                <div className="bg-white p-4 rounded-lg w-full min-h-[400px] flex items-start justify-center overflow-hidden">
                  <MermaidDiagram
                    id="m2-chart"
                    chartDefinition={m2Chart}
                    activeStep={m2Step}
                  />
                </div>
                <div className="mt-4 bg-slate-800 p-3 rounded-lg">
                  <div className="text-sm text-slate-400">M2 狀態</div>
                  <div className="text-lg font-mono">
                    N = <span className="text-yellow-400">{m2State.N}</span> |
                    輸出 ={" "}
                    <span className="text-orange-400">{m2State.output}</span>
                  </div>
                </div>
              </div>
            </div>

            <div className="text-center py-6">
              <button
                onClick={runTrace}
                disabled={isRunning}
                className={`px-8 py-3 rounded-full font-bold text-lg transition-all ${
                  isRunning
                    ? "bg-slate-700 text-slate-500"
                    : "bg-blue-600 hover:bg-blue-500 text-white shadow-lg"
                }`}
              >
                {isRunning ? "追蹤中..." : "▶ 開始追蹤 (N=10)"}
              </button>
            </div>

            {finished && (
              <div className="text-center p-6 bg-green-900/20 border border-green-500/30 rounded-xl">
                <p className="text-green-300 font-bold text-xl mb-2">結果</p>
                <p className="text-slate-300">
                  M1 和 M2 都輸出{" "}
                  <span className="text-green-400 font-bold">2 罐汽水</span>
                </p>
                <p className="text-yellow-400 font-bold mt-4 text-lg">
                  答案：C (兩者都輸出 2 罐)
                </p>
              </div>
            )}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
