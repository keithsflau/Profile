<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HKDSE 2025 Paper 1B Q9 - Check Digit Flowchart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: #0f172a;
        color: #e2e8f0;
      }
      /* Flowchart overrides for paper style */
      .mermaid .node rect,
      .mermaid .node polygon,
      .mermaid .node circle,
      .mermaid .node path {
        fill: #ffffff;
        stroke: #000000;
        stroke-width: 2px;
      }
      .mermaid .edgePath .path {
        stroke: #000000 !important;
        stroke-width: 2px !important;
      }
      .mermaid .marker {
        fill: #000000 !important;
        stroke: #000000 !important;
      }
      .mermaid .nodeLabel {
        color: #000;
      }

      /* Active state overrides */
      /* Note: Mermaid classes sometimes apply to g elements or path/rect inside */
      g.activeNode > rect,
      g.activeNode > polygon,
      g.activeNode > circle,
      g.activeNode > path {
        fill: #dbeafe !important;
        stroke: #2563eb !important;
        stroke-width: 3px !important;
        filter: drop-shadow(0 0 5px #3b82f6);
      }
    </style>
  </head>
  <body class="min-h-screen p-4 md:p-8">
    <div id="root" class="w-full max-w-6xl mx-auto"></div>
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // Initialize mermaid
      mermaid.initialize({
        startOnLoad: false,
        theme: "base",
        flowchart: {
          curve: "linear",
          padding: 20,
        },
        themeVariables: {
          primaryColor: "#ffffff",
          primaryBorderColor: "#000000",
          lineColor: "#000000",
          fontFamily: '"Inter", sans-serif',
        },
      });

      const MermaidDiagram = ({ id, chartDefinition, activeStep }) => {
        const containerRef = useRef(null);

        useEffect(() => {
          if (containerRef.current) {
            const uniqueId = `${id}-${Date.now()}`;
            // Inject class for active step
            // Always numeric N{activeStep}
            let highlightStyle = "";
            if (activeStep > 0) {
              highlightStyle = `\nclass N${activeStep} activeNode;`;
            }

            const finalChart = `
              ${chartDefinition}
              classDef activeNode fill:#dbeafe,stroke:#2563eb,stroke-width:3px;
              classDef hidden width:0px,height:0px,opacity:0;
              classDef label font-weight:bold;
              ${highlightStyle}
            `;

            containerRef.current.innerHTML = "";
            try {
              mermaid.render(uniqueId, finalChart).then((result) => {
                containerRef.current.innerHTML = result.svg;
              });
            } catch (e) {
              console.error("Mermaid error:", e);
            }
          }
        }, [id, chartDefinition, activeStep]);

        return (
          <div ref={containerRef} className="flex justify-center w-full" />
        );
      };

      const App = () => {
        const [inputs, setInputs] = useState({ F: 1, C: "A", N: 24, D: 8 });
        const [activeStep, setActiveStep] = useState(0);
        const [vars, setVars] = useState({ S: 0 });
        const [result, setResult] = useState(null);
        const [log, setLog] = useState([]);
        const [isRunning, setIsRunning] = useState(false);
        const timerRef = useRef(null);

        // Define Mermaid Chart logic
        // Use N1..N14 for all nodes to prevent ID issues
        // N13: Valid Output
        // N14: Invalid Output
        const chartDefinition = `
          flowchart TD
            N1((START)) --> N2[/Input F, C, N, D/]
            N2 --> N3[S ← 0]
            N3 --> N4{1 ≤ F ≤ 6?}
            N4 -- No --> N14[/Invalid/]
            N4 -- Yes --> N5{1 ≤ N ≤ 40?}
            
            N5 -- No --> N14
            N5 -- Yes --> N6[S ← F + N]
            
            N6 --> N7{C = 'A'?}
            N7 -- Yes --> N8[S ← S + 3]
            N7 -- No --> N9{C = 'B'?}
            
            N9 -- Yes --> N10[S ← S * 3]
            N9 -- No --> Join(( )):::hidden
            
            N8 --> Join
            N10 --> Join
            
            Join --> N11[S ← S mod 10]
            N11 --> N12{S = D?}
            N12 -- Yes --> N13[/Valid/]
            N12 -- No --> N14
            
            classDef default fill:#fff,stroke:#000,stroke-width:2px;
            linkStyle default stroke-width:2px,fill:none,stroke:black;
        `;

        const runTrace = () => {
          if (isRunning) return;
          setIsRunning(true);
          setActiveStep(0);
          setVars({ S: 0 });
          setResult(null);
          setLog([]);

          const { F, C, N, D } = inputs;
          const steps = [];

          // Trace Logic
          steps.push({ step: 1, S: 0, log: "START" });
          steps.push({
            step: 2,
            S: 0,
            log: `Input: F=${F}, C=${C}, N=${N}, D=${D}`,
          });
          steps.push({ step: 3, S: 0, log: "S ← 0" });

          if (F < 1 || F > 6) {
            steps.push({ step: 4, S: 0, log: `1≤F≤6? NO → Invalid` });
            steps.push({
              step: 14,
              S: 0,
              log: "Output: Invalid",
              result: "INVALID",
            });
          } else {
            steps.push({ step: 4, S: 0, log: `1≤F≤6? YES` });
            if (N < 1 || N > 40) {
              steps.push({ step: 5, S: 0, log: `1≤N≤40? NO → Invalid` });
              steps.push({
                step: 14,
                S: 0,
                log: "Output: Invalid",
                result: "INVALID",
              });
            } else {
              steps.push({ step: 5, S: 0, log: `1≤N≤40? YES` });
              let S = F + N;
              steps.push({ step: 6, S, log: `S ← F + N = ${S}` });

              if (C === "A") {
                steps.push({ step: 7, S, log: `C='A'? YES` });
                S = S + 3;
                steps.push({ step: 8, S, log: `S ← S + 3 = ${S}` });
              } else {
                steps.push({ step: 7, S, log: `C='A'? NO` });
                if (C === "B") {
                  steps.push({ step: 9, S, log: `C='B'? YES` });
                  S = S * 3;
                  steps.push({ step: 10, S, log: `S ← S * 3 = ${S}` });
                } else {
                  steps.push({ step: 9, S, log: `C='B'? NO` });
                }
              }

              // Join
              S = S % 10;
              steps.push({ step: 11, S, log: `S ← S mod 10 = ${S}` });

              if (S === parseInt(D)) {
                steps.push({
                  step: 12,
                  S,
                  log: `S=${S} == D=${D}? YES`,
                });
                steps.push({
                  step: 13,
                  S,
                  log: "Output: Valid",
                  result: "VALID",
                });
              } else {
                steps.push({
                  step: 12,
                  S,
                  log: `S=${S} != D=${D}? NO`,
                });
                steps.push({
                  step: 14,
                  S,
                  log: "Output: Invalid",
                  result: "INVALID",
                });
              }
            }
          }

          let i = 0;
          timerRef.current = setInterval(() => {
            if (i >= steps.length) {
              clearInterval(timerRef.current);
              setIsRunning(false);
              return;
            }
            setActiveStep(steps[i].step);
            setVars({ S: steps[i].S });
            setLog((prev) => [...prev, steps[i].log]);
            if (steps[i].result) setResult(steps[i].result);
            i++;
          }, 800);
        };

        return (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="space-y-4">
              <div className="text-center">
                <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-blue-900/30 border border-blue-500/30 text-blue-400 font-bold">
                  HKDSE 2025 Paper 1B Q9
                </div>
                <h1 className="text-2xl font-bold text-white mt-2">
                  Check Digit Flowchart
                </h1>
              </div>

              <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                <div className="grid grid-cols-4 gap-3 mb-4">
                  {["F", "C", "N", "D"].map((k) => (
                    <div key={k}>
                      <label className="text-xs text-cyan-400 font-bold">
                        {k}
                      </label>
                      <input
                        type={k === "C" ? "text" : "number"}
                        value={inputs[k]}
                        onChange={(e) =>
                          setInputs({
                            ...inputs,
                            [k]:
                              k === "C"
                                ? e.target.value.toUpperCase()
                                : parseInt(e.target.value) || 0,
                          })
                        }
                        className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-center font-mono"
                      />
                    </div>
                  ))}
                </div>
                <button
                  onClick={runTrace}
                  disabled={isRunning}
                  className={`w-full py-3 rounded-lg font-bold ${
                    isRunning
                      ? "bg-slate-700 text-slate-500"
                      : "bg-blue-600 hover:bg-blue-500 text-white"
                  }`}
                >
                  {isRunning ? "Tracing..." : "▶ Trace Algorithm"}
                </button>
              </div>

              <div className="bg-slate-900 p-4 rounded-xl border border-slate-700">
                <div className="flex gap-4 mb-4">
                  <div className="bg-slate-800 p-3 rounded-lg text-center">
                    <div className="text-xs text-slate-400">S</div>
                    <div className="text-2xl font-mono text-green-400">
                      {vars.S}
                    </div>
                  </div>
                  <div className="bg-slate-800 p-3 rounded-lg text-center flex-1">
                    <div className="text-xs text-slate-400">Result</div>
                    <div
                      className={`text-xl font-bold ${
                        result === "VALID"
                          ? "text-green-400"
                          : result === "INVALID"
                          ? "text-red-400"
                          : "text-slate-600"
                      }`}
                    >
                      {result || "..."}
                    </div>
                  </div>
                </div>
                <div className="h-48 overflow-y-auto bg-slate-950 p-2 rounded font-mono text-xs space-y-1">
                  {log.map((l, i) => (
                    <div
                      key={i}
                      className="border-l-2 border-blue-500/50 pl-2 text-slate-300"
                    >
                      ▸ {l}
                    </div>
                  ))}
                  {log.length === 0 && (
                    <span className="text-slate-600 italic">Ready...</span>
                  )}
                </div>
              </div>
            </div>

            <div className="flex justify-center bg-white rounded-xl p-4 min-h-[600px] items-start overflow-auto">
              <MermaidDiagram
                id="check-digit-chart"
                chartDefinition={chartDefinition}
                activeStep={activeStep}
              />
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
