<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Fireworks - æ¼¢å­—ç…™ç« (æ“´å……ç‰ˆ)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background-color: #0f172a; }
        canvas { display: block; }
        .no-select { user-select: none; -webkit-user-select: none; }
        /* Glow animation for UI */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); }
        }
        .btn-active { animation: pulse-glow 2s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Config ---
        const GRAVITY = 0.12; 
        const PARTICLE_COUNT = 300; 
        const TEXT_SIZE = 180;
        
        // --- 6x6 é«˜å‘½ä¸­ç‡çµ„åˆæ•¸æ“šåº« ---
        // è¨­è¨ˆç‚º6å€‹éƒ¨é¦– x 6å€‹éƒ¨ä»¶ï¼Œå…±36ç¨®çµ„åˆï¼Œå…¶ä¸­22ç¨®æœ‰æ•ˆï¼ˆç´„61%å‘½ä¸­ç‡ï¼‰
        // ä½¿ç”¨å¸¸è¦‹æ¼¢å­—ï¼Œç¢ºä¿æº–ç¢ºæ€§
        const COMBINATIONS = [
            // æœ¨ (Wood) - 6å€‹çµ„åˆï¼Œå…¨éƒ¨æœ‰æ•ˆï¼
            { radical: 'æœ¨', part: 'å¯', result: 'æŸ¯', color: '#4ade80' }, // Green
            { radical: 'æœ¨', part: 'å¤', result: 'æ¯', color: '#86efac' },
            { radical: 'æœ¨', part: 'å¯º', result: 'æŸ¿', color: '#16a34a' },
            { radical: 'æœ¨', part: 'å·¥', result: 'æ ', color: '#22c55e' },
            { radical: 'æœ¨', part: 'å­', result: 'æ', color: '#15803d' },
            { radical: 'æœ¨', part: 'ç™½', result: 'æŸ', color: '#10b981' },

            // æ°´ (Water) - 4å€‹æœ‰æ•ˆçµ„åˆ
            { radical: 'æ°´', part: 'å¯', result: 'æ²³', color: '#0ea5e9' }, // Blue
            { radical: 'æ°´', part: 'å¤', result: 'æ²½', color: '#3b82f6' },
            { radical: 'æ°´', part: 'å·¥', result: 'æ±Ÿ', color: '#2563eb' },
            { radical: 'æ°´', part: 'ç™½', result: 'æ³Š', color: '#60a5fa' },

            // äºº (Person) - 4å€‹æœ‰æ•ˆçµ„åˆ
            { radical: 'äºº', part: 'å¯', result: 'ä½•', color: '#f97316' }, // Orange
            { radical: 'äºº', part: 'å¤', result: 'ä¼°', color: '#fb923c' },
            { radical: 'äºº', part: 'å¯º', result: 'ä¾', color: '#ea580c' },
            { radical: 'äºº', part: 'ç™½', result: 'ä¼¯', color: '#fdba74' },

            // å£ (Mouth) - 2å€‹æœ‰æ•ˆçµ„åˆ
           // Yellow
            { radical: 'å£', part: 'å¤', result: 'å’•', color: '#fde047' },

            // å¥³ (Woman) - 3å€‹æœ‰æ•ˆçµ„åˆ
            { radical: 'å¥³', part: 'å¤', result: 'å§‘', color: '#e879f9' }, // Pink
            { radical: 'å¥³', part: 'å­', result: 'å¥½', color: '#c026d3' },

            // è¨€ (Speech) - 3å€‹æœ‰æ•ˆçµ„åˆ
            { radical: 'è¨€', part: 'å¤', result: 'è©', color: '#a78bfa' }, // Purple
            { radical: 'è¨€', part: 'å¯º', result: 'è©©', color: '#8b5cf6' },
            { radical: 'è¨€', part: 'å·¥', result: 'è¨Œ', color: '#7c3aed' },
        ];

        // 6x6 UI æŒ‰éˆ•åˆ—è¡¨ - ç°¡åŒ–ç‚º6å€‹éƒ¨é¦–å’Œ6å€‹éƒ¨ä»¶
        const UI_RADICALS = ['æœ¨', 'æ°´', 'äºº', 'å£', 'å¥³', 'è¨€'];
        const UI_PARTS = ['å¯', 'å¤', 'å¯º', 'å·¥', 'å­', 'ç™½'];

        const App = () => {
            const canvasRef = useRef(null);
            const [selectedRadical, setSelectedRadical] = useState(UI_RADICALS[0]);
            const [selectedPart, setSelectedPart] = useState(UI_PARTS[0]);
            const [message, setMessage] = useState("ğŸš€ ç³»çµ±å°±ç·’ï¼šè«‹é¸æ“‡éƒ¨é¦–èˆ‡éƒ¨ä»¶");
            const [comboResult, setComboResult] = useState(null);

            const stateRef = useRef({
                rockets: [],
                particles: [],
                width: window.innerWidth,
                height: window.innerHeight,
                sprites: {} 
            });

            // é å…ˆç”¢ç”Ÿå…‰æšˆè²¼åœ– (æ•ˆèƒ½å„ªåŒ–æ ¸å¿ƒ)
            const getParticleSprite = (color) => {
                if (stateRef.current.sprites[color]) return stateRef.current.sprites[color];
                const size = 32; 
                const c = document.createElement('canvas');
                c.width = size;
                c.height = size;
                const ctx = c.getContext('2d');
                const gradient = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
                gradient.addColorStop(0, color);
                gradient.addColorStop(0.3, color); 
                gradient.addColorStop(1, 'rgba(0,0,0,0)'); 
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(16, 16, 16, 0, Math.PI * 2);
                ctx.fill();
                stateRef.current.sprites[color] = c;
                return c;
            };

            const getTextPoints = (text, width, height) => {
                const offCanvas = document.createElement('canvas');
                offCanvas.width = width;
                offCanvas.height = height;
                const ctx = offCanvas.getContext('2d');
                ctx.font = `bold ${TEXT_SIZE}px "Microsoft JhengHei", sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#fff';
                // ç¨å¾®ç•«é«˜ä¸€é»ï¼Œè®“å­—åœ¨ç©ºä¸­
                ctx.fillText(text, width / 2, height * 0.3);
                const imageData = ctx.getImageData(0, 0, width, height);
                const points = [];
                const gap = 5; // æ¡æ¨£å¯†åº¦ï¼Œè¶Šå°ç²’å­è¶Šå¯†ä½†è¶Šæ…¢
                for (let y = 0; y < height; y += gap) {
                    for (let x = 0; x < width; x += gap) {
                        if (imageData.data[(y * width + x) * 4 + 3] > 128) points.push({ x, y });
                    }
                }
                return points;
            };

            const createExplosion = (x, y, charData) => {
                const isSuccess = charData !== null;
                const color = isSuccess ? charData.color : '#64748b'; // ç°è‰²ä»£è¡¨å¤±æ•—
                const sprite = getParticleSprite(color);
                
                let targetPoints = [];
                if (isSuccess) {
                    targetPoints = getTextPoints(charData.result, stateRef.current.width, stateRef.current.height);
                    // Fisher-Yates shuffle
                    for (let i = targetPoints.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [targetPoints[i], targetPoints[j]] = [targetPoints[j], targetPoints[i]];
                    }
                }

                // æ ¹æ“šæ˜¯å¦æˆåŠŸæ±ºå®šç²’å­æ•¸é‡
                const count = isSuccess ? Math.min(PARTICLE_COUNT, targetPoints.length + 50) : 60;

                for (let i = 0; i < count; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 8 + 3; // çˆ†ç‚¸åŠ›åº¦
                    
                    stateRef.current.particles.push({
                        x: x,
                        y: y,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        life: 1.0,
                        decay: Math.random() * 0.015 + 0.01,
                        color: color,
                        sprite: sprite,
                        target: isSuccess && targetPoints[i] ? targetPoints[i] : null,
                        delay: Math.random() * 15 // å»¶é²é£›å‘æ–‡å­—çš„æ™‚é–“
                    });
                }
            };

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d', { alpha: false });

                const handleResize = () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    stateRef.current.width = canvas.width;
                    stateRef.current.height = canvas.height;
                };
                window.addEventListener('resize', handleResize);
                handleResize();

                let animationId;
                const loop = () => {
                    const { rockets, particles, width, height } = stateRef.current;

                    // 1. èƒŒæ™¯æ¸…é™¤ (å¸¶æœ‰é€æ˜åº¦ä»¥ç”¢ç”Ÿæ‹–å°¾)
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.fillStyle = 'rgba(15, 23, 42, 0.25)'; 
                    ctx.fillRect(0, 0, width, height);

                    // 2. ç¹ªè£½ç«ç®­
                    ctx.fillStyle = '#ffffff';
                    const maxHeight = height * 0.25; // 3/4 é«˜åº¦é™åˆ¶ (å¾é ‚éƒ¨ç®—èµ· 1/4 è™•)
                    for (let i = rockets.length - 1; i >= 0; i--) {
                        const r = rockets[i];
                        r.x += r.vx;
                        r.y += r.vy;
                        r.vy += GRAVITY;
                        
                        // ç•«ç«ç®­é ­
                        ctx.beginPath();
                        ctx.arc(r.x, r.y, 4, 0, Math.PI * 2);
                        ctx.fill();

                        // åˆ¤æ–·æ˜¯å¦åˆ°é”é ‚é» (é€Ÿåº¦è½‰æ­£) æˆ–é”åˆ° 3/4 é«˜åº¦é™åˆ¶
                        if (r.vy >= -1 || r.y <= maxHeight) { 
                            createExplosion(r.x, r.y, r.charData);
                            rockets.splice(i, 1);
                        }
                    }

                    // 3. ç¹ªè£½ç²’å­ (ä½¿ç”¨ additive blending ç™¼å…‰)
                    ctx.globalCompositeOperation = 'lighter';
                    
                    for (let i = particles.length - 1; i >= 0; i--) {
                        const p = particles[i];
                        
                        if (p.target && p.delay <= 0) {
                            // Lerp: é£›å‘æ–‡å­—ç›®æ¨™é»
                            p.x += (p.target.x - p.x) * 0.15;
                            p.y += (p.target.y - p.y) * 0.15;
                            p.life -= 0.003; // æ–‡å­—å½¢æˆæ™‚æ·¡å‡ºè¼ƒæ…¢
                        } else {
                            // æ™®é€šç‰©ç†
                            p.x += p.vx;
                            p.y += p.vy;
                            p.vx *= 0.96;
                            p.vy *= 0.96;
                            p.vy += 0.08; // Gravity
                            if (p.delay > 0) p.delay--;
                            p.life -= p.decay;
                        }

                        if (p.life > 0) {
                            // æª¢æŸ¥é‚Šç•Œå„ªåŒ–
                            if (p.x > -50 && p.x < width + 50 && p.y > -50 && p.y < height + 50) {
                                const size = 32 * p.life;
                                ctx.drawImage(p.sprite, p.x - size/2, p.y - size/2, size, size);
                            }
                        } else {
                            particles.splice(i, 1);
                        }
                    }
                    animationId = requestAnimationFrame(loop);
                };
                animationId = requestAnimationFrame(loop);
                return () => {
                    cancelAnimationFrame(animationId);
                    window.removeEventListener('resize', handleResize);
                };
            }, []);

            const handleLaunch = () => {
                const combo = COMBINATIONS.find(c => c.radical === selectedRadical && c.part === selectedPart);
                
                // æª¢æŸ¥æ˜¯å¦æœ‰æ•ˆï¼Œæ›´æ–°è¨Šæ¯
                if (combo) {
                    setMessage(`ç™¼å°„æˆåŠŸï¼ ${combo.radical} + ${combo.part} = ${combo.result}`);
                    setComboResult(true);
                } else {
                    setMessage(`ç„¡æ•ˆçµ„åˆ (${selectedRadical} + ${selectedPart})ï¼Œè«‹å˜—è©¦å…¶ä»–æ­é…ï¼`);
                    setComboResult(false);
                }

                const startX = stateRef.current.width / 2;
                const startY = stateRef.current.height;
                
                // ç™¼å°„å¤šæšç«ç®­å¢å¼·è¦–è¦º
                const rocketCount = combo ? 1 : 1; 
                
                for(let i=0; i<rocketCount; i++) {
                    stateRef.current.rockets.push({
                        x: startX + (Math.random()-0.5)*20,
                        y: startY,
                        vx: (Math.random() - 0.5) * 4,
                        vy: -14 - Math.random() * 2, // éš¨æ©Ÿé€Ÿåº¦
                        charData: combo || null
                    });
                }
            };

            return (
                <div className="relative w-full h-screen font-sans select-none">
                    <canvas ref={canvasRef} className="absolute inset-0 w-full h-full" />
                    
                    {/* Header */}
                    <div className="absolute top-10 w-full text-center pointer-events-none z-10">
                         <h1 className="text-4xl md:text-6xl text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 font-black tracking-widest drop-shadow-[0_2px_10px_rgba(0,0,0,0.8)]">
                            æ¼¢å­—ç…™ç«å¤§æœƒ
                         </h1>
                         <p className={`mt-4 text-lg font-medium transition-colors duration-300 drop-shadow-md ${comboResult === true ? 'text-green-400' : comboResult === false ? 'text-red-400' : 'text-gray-300'}`}>
                            {message}
                         </p>
                    </div>

                    {/* Control Panel */}
                    <div className="absolute bottom-0 w-full bg-slate-900/80 backdrop-blur-xl border-t border-slate-700 p-4 md:p-6 z-20 flex flex-col items-center gap-4">
                        
                        <div className="flex flex-col md:flex-row items-center gap-4 md:gap-8 w-full justify-center">
                            
                            {/* Radical Row */}
                            <div className="flex flex-wrap justify-center gap-2">
                                <div className="w-full text-center text-xs text-slate-400 mb-1 uppercase tracking-wider">éƒ¨é¦– (Radical)</div>
                                {UI_RADICALS.map(r => (
                                    <button key={r} onClick={() => setSelectedRadical(r)}
                                        className={`w-10 h-10 md:w-12 md:h-12 rounded-lg border-2 text-lg font-bold transition-all duration-200 active:scale-95
                                            ${selectedRadical === r 
                                                ? 'bg-blue-600 border-blue-400 text-white shadow-[0_0_15px_rgba(37,99,235,0.6)] scale-110' 
                                                : 'bg-slate-800/50 border-slate-600 text-slate-400 hover:border-slate-400 hover:bg-slate-700'}`}>
                                        {r}
                                    </button>
                                ))}
                            </div>

                            <span className="text-2xl text-slate-600 hidden md:block">+</span>

                            {/* Part Row */}
                            <div className="flex flex-wrap justify-center gap-2">
                                <div className="w-full text-center text-xs text-slate-400 mb-1 uppercase tracking-wider">éƒ¨ä»¶ (Part)</div>
                                {UI_PARTS.map(p => (
                                    <button key={p} onClick={() => setSelectedPart(p)}
                                        className={`w-10 h-10 md:w-12 md:h-12 rounded-lg border-2 text-lg font-bold transition-all duration-200 active:scale-95
                                            ${selectedPart === p 
                                                ? 'bg-purple-600 border-purple-400 text-white shadow-[0_0_15px_rgba(147,51,234,0.6)] scale-110' 
                                                : 'bg-slate-800/50 border-slate-600 text-slate-400 hover:border-slate-400 hover:bg-slate-700'}`}>
                                        {p}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Launch Button */}
                        <button onClick={handleLaunch}
                            className="mt-2 w-full md:w-auto px-12 py-3 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-600 rounded-full text-white font-bold text-lg tracking-wider shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50 hover:scale-105 active:scale-95 transition-all">
                            ç™¼å°„ç…™ç« (LAUNCH) ğŸš€
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>