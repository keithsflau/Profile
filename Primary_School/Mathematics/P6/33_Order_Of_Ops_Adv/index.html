<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Â∞èÂÖ≠Êï∏Â≠∏ÔºöÈÄ≤ÈöéÂõõÂâáÈÅãÁÆó | Order of Operations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Outfit:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="../../common/i18n.js"></script>
    <style>
      body {
        font-family: "Outfit", "Noto Sans TC", sans-serif;
        background: #0f172a;
        color: white;
        overflow-x: hidden;
      }
      .glass-panel {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect } = React;
      const { motion, AnimatePresence } = window.Motion;
      const { LanguageSelector } = window.MathI18n || {
        LanguageSelector: () => null,
      };

      const t = {
        title: {
          en: "Order of Operations",
          zh: "ÂõõÂâáÈÅãÁÆó",
          ja: "Ë®àÁÆó„ÅÆÈ†ÜÂ∫è",
          ko: "Ïó∞ÏÇ∞ ÏàúÏÑú",
          es: "Orden de Operaciones",
          de: "Rechenreihenfolge",
          fi: "Laskuj√§rjestys",
          fr: "Ordre des op√©rations",
          ar: "ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿπŸÖŸÑŸäÿßÿ™",
          it: "Ordine delle Operazioni",
        },
        instruction: {
          en: "Tap the part to solve next!",
          zh: "ÈªûÊìä‰∏ã‰∏ÄÊ≠•Ë¶ÅË®àÁÆóÁöÑÈÉ®ÂàÜÔºÅ",
          ja: "Ê¨°„Å´Ë®àÁÆó„Åô„ÇãÈÉ®ÂàÜ„Çí„Çø„ÉÉ„ÉóÔºÅ",
          ko: "Îã§ÏùåÏóê Í≥ÑÏÇ∞Ìï† Î∂ÄÎ∂ÑÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî!",
          es: "¬°Toca la parte para resolver!",
          de: "Tippe auf den n√§chsten Schritt!",
          fi: "Napauta seuraavaksi laskettavaa osaa!",
          fr: "Touchez la partie √† r√©soudre !",
          ar: "ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑŸÖÿ±ÿßÿØ ÿ≠ŸÑŸá ÿ™ÿßŸÑŸäÿßŸã!",
          it: "Tocca la parte da risolvere!",
        },
        correct: {
          en: "Correct!",
          zh: "Ê≠£Á¢∫ÔºÅ",
          ja: "Ê≠£Ëß£ÔºÅ",
          ko: "Ï†ïÎãµ!",
          es: "¬°Correcto!",
          de: "Richtig!",
          fi: "Oikein!",
          fr: "Correct !",
          ar: "ÿµÿ≠Ÿäÿ≠!",
          it: "Corretto!",
        },
        wrong: {
          en: "Ops! Check BODMAS rules.",
          zh: "ÂìéÂëÄÔºÅÊ™¢Êü•ÂÖà‰πòÈô§ÂæåÂä†Ê∏õ„ÄÇ",
          ja: "„Åä„Å£„Å®ÔºÅ„É´„Éº„É´„ÅÆÁ¢∫Ë™ç„Çí„ÄÇ",
          ko: "Ïù¥Îü∞! Í∑úÏπôÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.",
          es: "¬°Ops! Revisa las reglas.",
          de: "Hoppla! Regeln pr√ºfen.",
          fi: "Hups! Tarkista s√§√§nn√∂t.",
          fr: "Oups ! V√©rifiez les r√®gles.",
          ar: "ÿ£ŸàŸàÿ®ÿ≥! ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÇŸàÿßÿπÿØ.",
          it: "Ops! Controlla le regole.",
        },
        complete: {
          en: "Expression Solved!",
          zh: "ÂºèÂ≠êÂ∑≤Ëß£ÈñãÔºÅ",
          ja: "Ë®àÁÆóÂÆå‰∫ÜÔºÅ",
          ko: "Í≥ÑÏÇ∞ ÏôÑÎ£å!",
          es: "¬°Expresi√≥n Resuelta!",
          de: "Ausdruck gel√∂st!",
          fi: "Lauseke ratkaistu!",
          fr: "Expression r√©solue !",
          ar: "ÿ™ŸÖ ÿ≠ŸÑ ÿßŸÑÿ™ÿπÿ®Ÿäÿ±!",
          it: "Espressione Risolta!",
        },
        next: {
          en: "Next Problem",
          zh: "‰∏ã‰∏ÄÈ°å",
          ja: "Ê¨°„ÅÆÂïèÈ°å",
          ko: "Îã§Ïùå Î¨∏Ï†ú",
          es: "Siguiente Problema",
          de: "N√§chste Aufgabe",
          fi: "Seuraava teht√§v√§",
          fr: "Probl√®me suivant",
          ar: "ÿßŸÑŸÖÿ≥ÿ£ŸÑÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©",
          it: "Prossimo Problema",
        },
      };

      const getText = (key, lang) => t[key]?.[lang] || t[key]?.["en"] || key;

      // Simple parser/structure for problems
      // A problem is a recursive structure or a list of steps
      // Let's use a flat token list for simplicity in UI, but logic to track "clickable" ranges
      const levels = [
        {
          id: 1,
          expr: [3, "+", 4, "√ó", 2],
          steps: [
            { range: [2, 4], res: 8, newExpr: [3, "+", 8] },
            { range: [0, 2], res: 11, newExpr: [11] },
          ],
        },
        {
          id: 2,
          expr: [10, "-", 3, "√ó", 2],
          steps: [
            { range: [2, 4], res: 6, newExpr: [10, "-", 6] },
            { range: [0, 2], res: 4, newExpr: [4] },
          ],
        },
        {
          id: 3,
          expr: ["(", 5, "+", 3, ")", "√ó", 2],
          steps: [
            { range: [0, 4], res: 8, newExpr: [8, "√ó", 2] }, // ( 5 + 3 ) -> index 0 to 4
            { range: [0, 2], res: 16, newExpr: [16] },
          ],
        },
        {
          id: 4,
          expr: [20, "√∑", "(", 6, "-", 2, ")"],
          steps: [
            { range: [2, 6], res: 4, newExpr: [20, "√∑", 4] },
            { range: [0, 2], res: 5, newExpr: [5] },
          ],
        },
        {
          id: 5,
          expr: [2, "+", 3, "√ó", 4, "-", 5],
          steps: [
            { range: [2, 4], res: 12, newExpr: [2, "+", 12, "-", 5] },
            { range: [0, 2], res: 14, newExpr: [14, "-", 5] }, // or 12-5 but left-to-right + is first
            { range: [0, 2], res: 9, newExpr: [9] },
          ],
        },
      ];

      function App() {
        const [lang, setLang] = useState("zh");
        const [lvlIdx, setLvlIdx] = useState(0);
        const [currentExpr, setCurrentExpr] = useState(levels[0].expr);
        const [stepIdx, setStepIdx] = useState(0); // Which step we are on
        const [feedback, setFeedback] = useState("");
        const [history, setHistory] = useState([]);

        useEffect(() => {
          resetLevel();
        }, [lvlIdx]);

        const resetLevel = () => {
          setCurrentExpr(levels[lvlIdx].expr);
          setStepIdx(0);
          setHistory([]);
          setFeedback("");
        };

        const handleTokenClick = (index) => {
          if (stepIdx >= levels[lvlIdx].steps.length) return;

          const targetStep = levels[lvlIdx].steps[stepIdx];
          // Check if click is within the target range
          // Actually, we want them to click the operator usually, or any part of the sub-expression
          if (index >= targetStep.range[0] && index <= targetStep.range[1]) {
            // Correct
            setFeedback("correct");
            // Animate transition
            setTimeout(() => {
              setHistory((prev) => [...prev, currentExpr.join(" ") + " = ..."]);
              setCurrentExpr(targetStep.newExpr);
              setStepIdx(stepIdx + 1);
              setFeedback("");
            }, 800);
          } else {
            setFeedback("wrong");
            setTimeout(() => setFeedback(""), 1500);
          }
        };

        const isFinished = stepIdx >= levels[lvlIdx].steps.length;

        const nextLevel = () => {
          setLvlIdx((lvlIdx + 1) % levels.length);
        };

        return (
          <div className="min-h-screen flex flex-col items-center p-4 font-sans bg-slate-900 text-white">
            <div className="w-full max-w-5xl flex justify-between items-center mb-10">
              <h1 className="text-4xl font-black text-amber-400 drop-shadow-[0_0_15px_rgba(251,191,36,0.5)]">
                üî¢ {getText("title", lang)}
              </h1>
              <div className="flex bg-slate-800/80 p-1.5 rounded-xl border border-white/10 flex-wrap justify-end gap-1 max-w-[50%]">
                {[
                  "zh",
                  "en",
                  "ja",
                  "ko",
                  "es",
                  "de",
                  "fi",
                  "fr",
                  "ar",
                  "it",
                ].map((l) => (
                  <button
                    key={l}
                    onClick={() => setLang(l)}
                    className={`px-3 py-1.5 rounded-lg font-bold text-xs uppercase transition-all ${
                      lang === l
                        ? "bg-amber-600 text-white shadow-lg scale-105"
                        : "text-slate-400 hover:text-white hover:bg-white/5"
                    }`}
                  >
                    {l}
                  </button>
                ))}
              </div>
            </div>

            <div className="w-full max-w-3xl flex flex-col gap-8">
              {/* Main Display */}
              <div className="glass-panel p-12 rounded-3xl min-h-[300px] flex flex-col items-center justify-center relative">
                <AnimatePresence>
                  {isFinished ? (
                    <motion.div
                      initial={{ opacity: 0, scale: 0.5 }}
                      animate={{ opacity: 1, scale: 1 }}
                      className="text-center"
                    >
                      <div className="text-6xl font-black text-green-400 mb-4">
                        {currentExpr[0]}
                      </div>
                      <div className="text-2xl font-bold text-slate-300 mb-8">
                        {getText("complete", lang)}
                      </div>
                      <button
                        onClick={nextLevel}
                        className="bg-amber-500 hover:bg-amber-400 text-slate-900 px-8 py-3 rounded-xl font-bold shadow-lg transition-transform active:scale-95"
                      >
                        {getText("next", lang)}
                      </button>
                    </motion.div>
                  ) : (
                    <div className="flex flex-wrap gap-4 items-center justify-center text-5xl md:text-7xl font-mono font-bold">
                      {currentExpr.map((token, i) => (
                        <motion.button
                          key={`${stepIdx}-${i}`} // Force re-render on step change
                          layout
                          whileHover={{ scale: 1.1, color: "#fbbf24" }}
                          whileTap={{ scale: 0.9 }}
                          onClick={() => handleTokenClick(i)}
                          className={`p-2 rounded-xl transition-colors ${
                            typeof token === "number"
                              ? "text-white"
                              : "text-amber-400"
                          }`}
                        >
                          {token}
                        </motion.button>
                      ))}
                    </div>
                  )}
                </AnimatePresence>

                {/* Feedback Overlay */}
                <AnimatePresence>
                  {feedback && (
                    <motion.div
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      exit={{ opacity: 0 }}
                      className={`absolute bottom-8 px-6 py-2 rounded-full font-bold text-lg pointer-events-none
                                  ${
                                    feedback === "correct"
                                      ? "bg-green-500/20 text-green-400 border border-green-500/50"
                                      : "bg-red-500/20 text-red-400 border border-red-500/50"
                                  }
                              `}
                    >
                      {getText(feedback, lang)}
                    </motion.div>
                  )}
                </AnimatePresence>
              </div>

              {/* Instruction */}
              {!isFinished && (
                <div className="text-center text-slate-400 font-bold uppercase tracking-widest text-sm animate-pulse">
                  {getText("instruction", lang)}
                </div>
              )}

              {/* History/Steps */}
              <div className="bg-slate-800/50 p-6 rounded-2xl border border-white/5">
                <h3 className="text-sm font-bold text-slate-500 uppercase mb-4">
                  Steps
                </h3>
                {history.length === 0 && (
                  <div className="text-slate-600 italic text-sm">...</div>
                )}
                {history.map((h, i) => (
                  <div
                    key={i}
                    className="text-slate-400 font-mono mb-2 text-lg opactiy-60"
                  >
                    {h}
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
