<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>小五數學：代數入門 | Algebra Intro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.min.js"></script>
    <script src="../../common/i18n.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Outfit:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Outfit", "Noto Sans TC", sans-serif;
        background: #0f172a;
        color: white;
        overflow-x: hidden;
      }
      .glass-panel {
        background: rgba(88, 28, 135, 0.2); /* Purple 900 */
        backdrop-filter: blur(12px);
        border: 1px solid rgba(168, 85, 247, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      .balance-arm {
        width: 100%;
        max-width: 500px;
        height: 12px;
        background: linear-gradient(90deg, #334155, #94a3b8, #334155);
        border-radius: 6px;
        position: relative;
        transform-origin: center;
        transition: transform 1s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      .balance-pivot {
        width: 0;
        height: 0;
        border-left: 20px solid transparent;
        border-right: 20px solid transparent;
        border-bottom: 60px solid #475569;
        margin-top: -10px;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect } = React;
      const { motion, AnimatePresence } = window.Motion;
      const { Scale, Check, RefreshCw, Lightbulb, Trophy } = window.LucideReact;
      const { LanguageSelector } = window.MathI18n || {
        LanguageSelector: () => null,
      };

      const t = {
        title: {
          en: "Algebra Balance Scale",
          zh: "代數平衡天秤",
          ja: "代数天秤",
          ko: "대수 천칭",
          es: "Balanza de Álgebra",
          de: "Algebra-Waage",
          fi: "Algebra-vaaka",
          fr: "Balance algébrique",
          ar: "ميزان الجبر",
          it: "Bilancia algebrica",
        },
        findX: {
          en: "Find value of x",
          zh: "找出 x 的值",
          ja: "xの値を求める",
          ko: "x의 값 찾기",
          es: "Encuentra valor de x",
          de: "Finde x",
          fi: "Etsi x",
          fr: "Trouver x",
          ar: "أوجد x",
          it: "Trova x",
        },
        equation: {
          en: "Equation",
          zh: "方程",
          ja: "方程式",
          ko: "방정식",
          es: "Ecuación",
          de: "Gleichung",
          fi: "Yhtälö",
          fr: "Équation",
          ar: "المعادلة",
          it: "Equazione",
        },
        check: {
          en: "Check Answer",
          zh: "檢查答案",
          ja: "答え合わせ",
          ko: "정답 확인",
          es: "Comprobar",
          de: "Prüfen",
          fi: "Tarkista",
          fr: "Vérifier",
          ar: "تحقق",
          it: "Controlla",
        },
        next: {
          en: "Next Problem",
          zh: "下一題",
          ja: "次の問題",
          ko: "다음 문제",
          es: "Siguiente",
          de: "Weiter",
          fi: "Seuraava",
          fr: "Suivant",
          ar: "التالي",
          it: "Avanti",
        },
        hint: {
          en: "Hint",
          zh: "提示",
          ja: "ヒント",
          ko: "힌트",
          es: "Pista",
          de: "Hinweis",
          fi: "Vihje",
          fr: "Indice",
          ar: "تلميح",
          it: "Suggerimento",
        },
        correct: {
          en: "Balanced!",
          zh: "平衡了！",
          ja: "釣り合った！",
          ko: "균형!",
          es: "¡Equilibrado!",
          de: "Ausgeglichen!",
          fi: "Tasapainossa!",
          fr: "Équilibré !",
          ar: "متوازن!",
          it: "Bilanciato!",
        },
        wrong: {
          en: "Not balanced yet...",
          zh: "還未平衡...",
          ja: "まだ釣り合っていません...",
          ko: "아직 균형 잡히지 않음...",
          es: "No equilibrado...",
          de: "Nicht ausgeglichen...",
          fi: "Ei tasapainossa...",
          fr: "Pas équilibré...",
          ar: "غير متوازن...",
          it: "Non bilanciato...",
        },
        score: {
          en: "Score",
          zh: "分數",
          ja: "スコア",
          ko: "점수",
          es: "Puntuación",
          de: "Punkte",
          fi: "Pisteet",
          fr: "Score",
          ar: "النتيجة",
          it: "Punteggio",
        },
        xVal: {
          en: "Enter x:",
          zh: "輸入 x:",
          ja: "xを入力:",
          ko: "x 입력:",
          es: "Ingresa x:",
          de: "x eingeben:",
          fi: "Syötä x:",
          fr: "Entrer x:",
          ar: "أدخل x:",
          it: "Inserisci x:",
        },
      };

      const getText = (key, lang) => t[key]?.[lang] || t[key]?.["en"] || key;

      function App() {
        const [lang, setLang] = useState("zh");
        const [level, setLevel] = useState(1);
        const [score, setScore] = useState(0);
        const [equation, setEquation] = useState({
          left: "x + 5",
          right: 12,
          ans: 7,
          type: "+",
        });
        const [userAns, setUserAns] = useState("");
        const [feedback, setFeedback] = useState(null); // null, correct, incorrect
        const [tilt, setTilt] = useState(0); // degrees

        const generateProblem = () => {
          const ops = ["+", "-", "×", "÷"];
          // Weights for difficulty or rotation? For P5, keep simple.
          const op = ops[Math.floor(Math.random() * 4)];

          let x, num, res, dispLeft;

          if (op === "+") {
            x = Math.floor(Math.random() * 10) + 1;
            num = Math.floor(Math.random() * 10) + 1;
            res = x + num;
            dispLeft = `x + ${num}`;
          } else if (op === "-") {
            x = Math.floor(Math.random() * 10) + 5;
            num = Math.floor(Math.random() * (x - 1)) + 1;
            res = x - num;
            dispLeft = `x - ${num}`; // Or num - x depending on level, keep x as subject usually
            // Let's do: x - num = res
          } else if (op === "×") {
            x = Math.floor(Math.random() * 9) + 2;
            num = Math.floor(Math.random() * 5) + 2;
            res = x * num;
            dispLeft = `${num}x`; // Standard algebra notation
          } else {
            // Divide
            x = Math.floor(Math.random() * 10) + 2;
            num = Math.floor(Math.random() * 5) + 2;
            // x / num = res -> x must be multiple
            let multiplier = Math.floor(Math.random() * 5) + 1;
            x = num * multiplier;
            res = multiplier;
            dispLeft = `x ÷ ${num}`;
          }

          setEquation({
            left: dispLeft,
            right: res,
            ans: x,
            type: op,
            num: num,
          });
          setUserAns("");
          setFeedback(null);
          setTilt(-15); // Start tilted to show imbalance
        };

        useEffect(() => {
          generateProblem();
        }, []);

        // Real-time tilt update based on input
        useEffect(() => {
          if (!userAns) {
            setTilt(-15);
            return;
          }
          const val = parseFloat(userAns);
          if (isNaN(val)) return;

          // Simplified physics:
          // Calculate LHS value with user's x
          let lhsVal = 0;
          if (equation.type === "+") lhsVal = val + equation.num;
          if (equation.type === "-") lhsVal = val - equation.num;
          if (equation.type === "×") lhsVal = val * equation.num; // Not quite equation.num is coefficient
          if (equation.left.includes("x")) {
            // re-parse properly
            // Easy hack: substituting in string? No unsafe eval.
            // let's follow logic from generation
            if (equation.type === "×")
              lhsVal = val * (equation.right / equation.ans); // derive co-eff
            else if (equation.type === "÷")
              lhsVal = val / (equation.ans / equation.right);
            else if (equation.type === "+")
              lhsVal = val + (equation.right - equation.ans);
            else if (equation.type === "-")
              lhsVal = val - (equation.ans - equation.right);
          }
          // Actually, simpler:
          // If user's x < correct x -> LHS < RHS -> Tilt Right (LHS goes up, RHS goes down? Wait. Heaviness.)
          // If LHS value < RHS value -> LHS is lighter -> LHS goes UP -> Rotate CW?
          // Wait, heavier side goes DOWN.
          // If LHS < RHS, LHS is lighter, RHS is heavier -> Tilt towards RHS (Clockwise positive angle?)
          // Let's say tilt is angle of bar.
          // 0 is flat. +deg is Right Down. -deg is Left Down.

          // Standard scale: Heavier goes down.
          // If user x < real x => LHS value < RHS value => RHS heavier => Tilt +
          // If user x > real x => LHS value > RHS value => LHS heavier => Tilt -

          if (val < equation.ans) setTilt(15);
          else if (val > equation.ans) setTilt(-15);
          else setTilt(0);
        }, [userAns, equation]);

        const check = () => {
          const val = parseInt(userAns);
          if (val === equation.ans) {
            setFeedback("correct");
            setScore((s) => s + 100);
            window.confetti && window.confetti();
          } else {
            setFeedback("wrong");
          }
        };

        return (
          <div className="min-h-screen flex flex-col items-center p-4">
            <div className="w-full max-w-4xl flex justify-between items-center mb-10">
              <h1 className="text-3xl md:text-5xl font-black text-purple-400 drop-shadow-[0_0_15px_rgba(168,85,247,0.5)]">
                ⚖️ {getText("title", lang)}
              </h1>
              <div className="bg-slate-800/80 p-1.5 rounded-xl border border-white/10 flex flex-wrap justify-end gap-1 max-w-[50%]">
                {[
                  "zh",
                  "en",
                  "ja",
                  "ko",
                  "es",
                  "de",
                  "fi",
                  "fr",
                  "ar",
                  "it",
                ].map((l) => (
                  <button
                    key={l}
                    onClick={() => setLang(l)}
                    className={`px-3 py-1.5 rounded-lg font-bold text-xs uppercase transition-all ${
                      lang === l
                        ? "bg-purple-600 text-white shadow-lg scale-105"
                        : "text-slate-400 hover:text-white hover:bg-white/5"
                    }`}
                  >
                    {l}
                  </button>
                ))}
              </div>
            </div>

            <div className="w-full max-w-5xl grid lg:grid-cols-3 gap-6">
              {/* Main Scale Area */}
              <div className="lg:col-span-2 flex flex-col gap-6">
                <div className="glass-panel p-8 rounded-3xl flex flex-col items-center justify-center min-h-[400px] relative">
                  <div className="absolute top-6 right-6 flex items-center gap-2 bg-slate-900/50 px-4 py-2 rounded-full border border-white/10">
                    <Trophy size={18} className="text-yellow-400" />
                    <span className="font-bold text-white">{score}</span>
                  </div>

                  {/* The Scale */}
                  <div className="scale-container w-full flex flex-col items-center pt-20">
                    {/* Bar */}
                    <motion.div
                      className="balance-arm flex justify-between items-end pb-1"
                      animate={{ rotate: tilt }}
                      transition={{
                        type: "spring",
                        stiffness: 60,
                        damping: 10,
                      }}
                    >
                      {/* Left Pan */}
                      <div
                        className="flex flex-col items-center -translate-x-8 translate-y-20 origin-top transform"
                        style={{ transform: `rotate(${-tilt}deg)` }}
                      >
                        {/* String */}
                        <div className="h-20 w-1 bg-slate-500/50 absolute bottom-full left-1/2 -translate-x-1/2"></div>

                        {/* Pan Content */}
                        <div className="w-32 h-24 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-xl shadow-lg flex items-center justify-center text-3xl font-black text-white relative z-10 border-t-4 border-indigo-400">
                          {equation.left}
                        </div>
                      </div>

                      {/* Right Pan */}
                      <div
                        className="flex flex-col items-center translate-x-8 translate-y-20 origin-top transform"
                        style={{ transform: `rotate(${-tilt}deg)` }}
                      >
                        <div className="h-20 w-1 bg-slate-500/50 absolute bottom-full left-1/2 -translate-x-1/2"></div>
                        <div className="w-32 h-24 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl shadow-lg flex items-center justify-center text-4xl font-black text-white relative z-10 border-t-4 border-purple-400">
                          {equation.right}
                        </div>
                      </div>
                    </motion.div>

                    {/* Pivot */}
                    <div className="balance-pivot"></div>
                    <div className="w-48 h-2 bg-slate-700 rounded-full mt-0"></div>
                  </div>
                </div>

                <div className="glass-panel p-6 rounded-2xl flex flex-col sm:flex-row items-center gap-4">
                  <div className="flex-1 flex items-center gap-4 w-full">
                    <span className="text-xl font-bold text-purple-200 whitespace-nowrap">
                      {getText("xVal", lang)}
                    </span>
                    <input
                      type="number"
                      value={userAns}
                      onChange={(e) => setUserAns(e.target.value)}
                      className="flex-1 bg-slate-900/60 border border-purple-500/30 rounded-xl px-4 py-3 text-2xl font-mono text-white text-center outline-none focus:border-purple-400 focus:shadow-[0_0_15px_rgba(168,85,247,0.3)] transition-all"
                      placeholder="?"
                    />
                  </div>
                  <button
                    onClick={check}
                    disabled={!userAns}
                    className="w-full sm:w-auto px-8 py-3 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-xl font-bold text-lg shadow-lg"
                  >
                    {getText("check", lang)}
                  </button>
                </div>
              </div>

              {/* Sidebar */}
              <div className="flex flex-col gap-6">
                <AnimatePresence mode="wait">
                  {feedback && (
                    <motion.div
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      exit={{ opacity: 0 }}
                      className={`glass-panel p-6 rounded-2xl flex flex-col items-center text-center ${
                        feedback === "correct"
                          ? "border-green-500/50 bg-green-500/10"
                          : "border-red-500/50 bg-red-500/10"
                      }`}
                    >
                      <div
                        className={`text-4xl mb-2 ${
                          feedback === "correct"
                            ? "text-green-400"
                            : "text-red-400"
                        }`}
                      >
                        {feedback === "correct" ? <Check size={48} /> : "❌"}
                      </div>
                      <div className="text-xl font-bold text-white mb-4">
                        {getText(feedback, lang)}
                      </div>
                      {feedback === "correct" && (
                        <button
                          onClick={generateProblem}
                          className="w-full py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold text-white flex items-center justify-center gap-2 transition-all"
                        >
                          <RefreshCw size={18} /> {getText("next", lang)}
                        </button>
                      )}
                    </motion.div>
                  )}
                </AnimatePresence>

                {!feedback && (
                  <div className="glass-panel p-6 rounded-2xl">
                    <h3 className="text-purple-300 font-bold uppercase tracking-widest text-sm mb-4 flex items-center gap-2">
                      <Lightbulb size={16} /> {getText("hint", lang)}
                    </h3>
                    <div className="text-slate-300 text-sm leading-relaxed">
                      Try entering different values for x. Watch how the scale
                      tilts!
                      <br />
                      <br />
                      If the left side (Blue) is lower, your x is too big.
                      <br />
                      If the right side (Pink) is lower, your x is too small.
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
