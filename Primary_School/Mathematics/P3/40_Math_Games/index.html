<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Â∞è‰∏âÊï∏Â≠∏ÔºöÊï∏Â≠∏ÈÅäÊ®ÇÂ†¥ | Math Playground</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="../../common/i18n.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Fredoka:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Fredoka", "Noto Sans TC", sans-serif;
        background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        cursor: crosshair;
        user-select: none;
      }
      .mole-hole {
        box-shadow: inset 0 10px 20px rgba(0, 0, 0, 0.5);
      }
      .mole {
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform-origin: bottom center;
      }
      .mole-enter {
        transform: translateY(100%);
      }
      .mole-active {
        transform: translateY(0%);
      }
      .mole-exit {
        transform: translateY(100%);
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useCallback } = React;
      const { LanguageSelector, get } = window.MathI18n;

      const t = {
        title: {
          en: "Math Playground",
          zh: "Êï∏Â≠∏ÈÅäÊ®ÇÂ†¥",
          ja: "Êï∞Â≠¶„ÅÆÈÅä„Å≥Â†¥",
          ko: "ÏàòÌïô ÎÜÄÏù¥ÌÑ∞",
          es: "Patio de recreo de matem√°ticas",
          de: "Mathe-Spielplatz",
          fi: "Matematiikan leikkikentt√§",
          fr: "Cour de r√©cr√©ation math√©matique",
          ar: "ŸÖŸÑÿπÿ® ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™",
          it: "Parco giochi matematico",
        },
        gameTitle: {
          en: "Counting Mole King",
          zh: "Êï∏Êï∏Âú∞Èº†Áéã",
          ja: "Êï∞„Åà„É¢„Ç∞„É©Áéã",
          ko: "ÎëêÎçîÏßÄ Ïôï ÏÑ∏Í∏∞",
          es: "Rey topo contando",
          de: "Z√§hlender Maulwurfsk√∂nig",
          fi: "Laskeva myyr√§ kuningas",
          fr: "Roi des taupes comptant",
          ar: "ÿπÿØ ŸÖŸÑŸÉ ÿßŸÑÿÆŸÑÿØ",
          it: "Re talpa che conta",
        },
        instruction: {
          en: "Hit all multiples of",
          zh: "ÊâìÊìäÊâÄÊúâ",
          ja: "„ÅÆÂÄçÊï∞„Çí„Åô„Åπ„Å¶Âè©„Åë",
          ko: "Ïùò Î∞∞ÏàòÎ•º Î™®Îëê ÏπòÏã≠ÏãúÏò§",
          es: "Golpea todos los m√∫ltiplos de",
          de: "Triff alle Vielfachen von",
          fi: "Osu kaikkiin kertoimiin",
          fr: "Frappez tous les multiples de",
          ar: "ÿßÿ∂ÿ±ÿ® ÿ¨ŸÖŸäÿπ ŸÖÿ∂ÿßÿπŸÅÿßÿ™",
          it: "Colpisci tutti i multipli di",
        },
        multiplesOf: {
          en: "Multiples of",
          zh: "ÁöÑÂÄçÊï∏",
          ja: "„ÅÆÂÄçÊï∞",
          ko: "Ïùò Î∞∞Ïàò",
          es: "M√∫ltiplos de",
          de: "Vielfache von",
          fi: "Kertoimet",
          fr: "Multiples de",
          ar: "ŸÖÿ∂ÿßÿπŸÅÿßÿ™",
          it: "Multipli di",
        },
        target: {
          en: "Target",
          zh: "ÁõÆÊ®ô",
          ja: "„Çø„Éº„Ç≤„ÉÉ„Éà",
          ko: "Î™©Ìëú",
          es: "Objetivo",
          de: "Ziel",
          fi: "Tavoite",
          fr: "Cible",
          ar: "ÿßŸÑŸáÿØŸÅ",
          it: "Obiettivo",
        },
        score: {
          en: "Score",
          zh: "ÂæóÂàÜ",
          ja: "„Çπ„Ç≥„Ç¢",
          ko: "Ï†êÏàò",
          es: "Puntuaci√≥n",
          de: "Punktzahl",
          fi: "Pisteet",
          fr: "Score",
          ar: "ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©",
          it: "Punteggio",
        },
        points: {
          en: "pts",
          zh: "ÂàÜ",
          ja: "ÁÇπ",
          ko: "Ï†ê",
          es: "pts",
          de: "Pkt",
          fi: "pisteet",
          fr: "pts",
          ar: "ŸÜŸÇÿßÿ∑",
          it: "pti",
        },
        gameOver: {
          en: "Game Over!",
          zh: "ÈÅäÊà≤ÁµêÊùü!",
          ja: "„Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÔºÅ",
          ko: "Í≤åÏûÑ Ïò§Î≤Ñ!",
          es: "¬°Juego terminado!",
          de: "Spiel vorbei!",
          fi: "Peli ohi!",
          fr: "Jeu termin√© !",
          ar: "ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÑÿπÿ®ÿ©!",
          it: "Gioco finito!",
        },
        yourScore: {
          en: "Your Score",
          zh: "‰Ω†ÁöÑÂæóÂàÜ",
          ja: "„ÅÇ„Å™„Åü„ÅÆ„Çπ„Ç≥„Ç¢",
          ko: "ÎãπÏã†Ïùò Ï†êÏàò",
          es: "Tu puntuaci√≥n",
          de: "Dein Punktsstand",
          fi: "Pisteesi",
          fr: "Votre score",
          ar: "ŸÜÿ™Ÿäÿ¨ÿ™ŸÉ",
          it: "Il tuo punteggio",
        },
        backToMenu: {
          en: "Back to Menu",
          zh: "Âõû‰∏ªÈÅ∏ÂñÆ",
          ja: "„É°„Éã„É•„Éº„Å´Êàª„Çã",
          ko: "Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞",
          es: "Volver al men√∫",
          de: "Zur√ºck zum Men√º",
          fi: "Takaisin valikkoon",
          fr: "Retour au menu",
          ar: "ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸÇÿßÿ¶ŸÖÿ©",
          it: "Torna al menu",
        },
        back: {
          en: "Back to Index",
          zh: "ËøîÂõûÁõÆÈåÑ",
          ja: "ÁõÆÊ¨°„Å´Êàª„Çã",
          ko: "Î™©Ï∞®Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞",
          es: "Volver al √≠ndice",
          de: "Zur√ºck zum Index",
          fi: "Takaisin hakemistoon",
          fr: "Retour √† l'index",
          ar: "ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑŸÅŸáÿ±ÿ≥",
          it: "Torna all'indice",
        },
      };

      function App() {
        const [lang, setLang] = useState("zh");
        const [gameState, setGameState] = useState("menu");
        const [target, setTarget] = useState(2);
        const [score, setScore] = useState(0);
        const [timeLeft, setTimeLeft] = useState(30);

        // Moles state: Array of objects or null.
        // Object: { val: number, isCorrect: boolean, id: number, status: 'active' | 'hit' | 'missed' }
        const [moles, setMoles] = useState(Array(9).fill(null));

        useEffect(() => {
          let interval;
          if (gameState === "playing") {
            interval = setInterval(() => {
              // 1. Pick a random hole
              const holeIdx = Math.floor(Math.random() * 9);

              // Only spawn if empty
              setMoles((prev) => {
                if (prev[holeIdx]) return prev; // Hole occupied

                const isTarget = Math.random() > 0.4;
                // Generate logic
                let num;
                if (isTarget) {
                  num = target * (Math.floor(Math.random() * 10) + 1);
                } else {
                  // Force wrong number
                  num =
                    target * (Math.floor(Math.random() * 10) + 1) +
                    (Math.random() > 0.5 ? 1 : -1);
                }

                const newMole = {
                  val: num,
                  id: Date.now() + Math.random(),
                  isCorrect: num % target === 0,
                  status: "active",
                };

                const newMoles = [...prev];
                newMoles[holeIdx] = newMole;
                return newMoles;
              });

              setTimeout(() => {
                setMoles((prev) => {
                  if (prev[holeIdx] && prev[holeIdx].status === "active") {
                    const n = [...prev];
                    n[holeIdx] = null;
                    return n;
                  }
                  return prev;
                });
              }, 1500);
            }, 800);
          }
          return () => clearInterval(interval);
        }, [gameState, target]);

        useEffect(() => {
          if (gameState === "playing") {
            if (timeLeft > 0) {
              const timer = setInterval(() => setTimeLeft((t) => t - 1), 1000);
              return () => clearInterval(timer);
            } else {
              setGameState("gameover");
            }
          }
        }, [gameState, timeLeft]);

        const whack = (idx, mole) => {
          if (!mole || mole.status !== "active") return;

          if (mole.isCorrect) {
            setScore((s) => s + 10);
            // Play sound?
          } else {
            setScore((s) => Math.max(0, s - 5));
          }

          setMoles((prev) => {
            const n = [...prev];
            n[idx] = null;
            return n;
          });
        };

        const startGame = (t) => {
          setTarget(t);
          setScore(0);
          setTimeLeft(30);
          setGameState("playing");
          setMoles(Array(9).fill(null));
        };

        const getText = (key) => t[key][lang] || t[key]["en"];

        return (
          <div className="min-h-screen p-4 flex flex-col items-center justify-center">
            <LanguageSelector lang={lang} setLang={setLang} />
            {gameState === "menu" && (
              <div className="bg-white/95 rounded-3xl p-12 text-center max-w-2xl w-full shadow-2xl animate-fade-in mt-12">
                <h1 className="text-6xl font-black text-green-800 mb-4">
                  üêπ {getText("gameTitle")}
                </h1>
                <p className="text-xl text-green-600 mb-8 font-bold">
                  {getText("instruction")}{" "}
                  <span className="text-2xl text-green-700">
                    {target === 2 ? "?" : ""}
                  </span>{" "}
                  {lang === "zh" || lang === "ja" || lang === "ko"
                    ? getText("multiplesOf")
                    : ""}
                </p>
                <div className="grid grid-cols-3 gap-4">
                  {[2, 3, 4, 5, 6, 9].map((n) => (
                    <button
                      key={n}
                      onClick={() => startGame(n)}
                      className="py-6 bg-green-100 hover:bg-green-500 hover:text-white text-green-800 rounded-2xl text-2xl font-black transition-all shadow-md transform hover:scale-105 active:scale-95"
                    >
                      {lang !== "zh" && lang !== "ja" && lang !== "ko"
                        ? getText("multiplesOf") + " "
                        : ""}
                      {n}
                      {lang === "zh" || lang === "ja" || lang === "ko"
                        ? " " + getText("multiplesOf")
                        : ""}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {gameState === "playing" && (
              <div className="w-full max-w-2xl mt-12">
                <div className="flex justify-between items-center mb-8 bg-black/40 backdrop-blur-md p-4 rounded-2xl text-white shadow-xl">
                  <div className="text-2xl font-black">
                    {getText("target")}:{" "}
                    <span className="text-yellow-300 text-3xl">{target}</span>{" "}
                    {getText("multiplesOf")}
                  </div>
                  <div className="text-4xl font-black text-yellow-300 drop-shadow-md">
                    {score} {getText("points")}
                  </div>
                  <div className="text-2xl font-bold font-mono">
                    ‚è±Ô∏è {timeLeft}
                  </div>
                </div>

                <div className="grid grid-cols-3 gap-6">
                  {moles.map((mole, i) => (
                    <div
                      key={i}
                      className="aspect-square bg-[#5d4037] rounded-full mole-hole relative overflow-hidden"
                      // Click handler on the HOLE to catch any clicks
                      onClick={() => whack(i, mole)}
                    >
                      {/* Mole */}
                      <div
                        className={`absolute bottom-0 left-0 right-0 h-[80%] flex items-center justify-center transition-transform duration-200 ${
                          mole ? "translate-y-0" : "translate-y-full"
                        }`}
                      >
                        {mole && (
                          <div
                            className={`w-[80%] h-full rounded-t-full flex flex-col items-center justify-center text-4xl font-black border-4 border-black/20 shadow-inner cursor-pointer active:scale-90 transition-transform ${
                              mole.isCorrect
                                ? "bg-yellow-400 text-yellow-900"
                                  ? "bg-yellow-400 text-yellow-900"
                                  : "bg-red-400 text-red-900"
                                : "bg-red-400 text-red-900"
                            }`}
                          >
                            <span className="z-10 mt-6">{mole.val}</span>
                            {/* Face */}
                            <div className="absolute top-4 flex gap-8">
                              <div className="w-3 h-3 bg-black rounded-full"></div>
                              <div className="w-3 h-3 bg-black rounded-full"></div>
                            </div>
                            <div className="absolute top-8 w-4 h-2 bg-black/50 rounded-full"></div>
                          </div>
                        )}
                      </div>

                      {/* Grass overlay */}
                      <div className="absolute bottom-0 w-full h-4 bg-green-600 rounded-b-full pointer-events-none z-20"></div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {gameState === "gameover" && (
              <div className="bg-white rounded-3xl p-12 text-center max-w-lg w-full shadow-2xl mt-12">
                <h2 className="text-5xl font-black text-slate-800 mb-4">
                  {getText("gameOver")}
                </h2>
                <div className="text-2xl text-slate-500 font-bold mb-2">
                  {getText("yourScore")}
                </div>
                <div className="text-8xl font-black text-green-600 mb-8">
                  {score}
                </div>
                <button
                  onClick={() => setGameState("menu")}
                  className="w-full py-4 bg-green-500 text-white rounded-xl font-black text-xl hover:bg-green-600 shadow-xl transition-transform active:scale-95"
                >
                  {getText("backToMenu")}
                </button>
              </div>
            )}
            <div className="fixed bottom-4 left-4">
              <a
                href="../index.html"
                className="bg-white/80 backdrop-blur hover:bg-white text-slate-600 px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 transition-all"
              >
                ‚Üê {getText("back")}
              </a>
            </div>
          </div>
        );
      }
      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
