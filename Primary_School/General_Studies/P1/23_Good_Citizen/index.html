<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Â∞è‰∏ÄÂ∏∏Ë≠òÔºöÂ•ΩÂ∏ÇÊ∞ëËø∑ÂÆÆ | Good Citizen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="../../common/i18n.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Fredoka:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Fredoka", "Noto Sans TC", sans-serif;
        background: linear-gradient(135deg, #ddd6fe 0%, #a78bfa 100%);
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect } = React;
      const { motion, AnimatePresence } = window.Motion;
      const { LanguageSelector, get } = window.MathI18n;

      const t = {
        title: {
          en: "Good Citizen Maze",
          zh: "Â•ΩÂ∏ÇÊ∞ëËø∑ÂÆÆ",
          ja: "ËâØ„ÅÑÂ∏ÇÊ∞ëËø∑Ë∑Ø",
        },
        instruction: {
          en: "Collect Good Deeds (Green) and avoid Bad Deeds (Red)!",
          zh: "Êî∂ÈõÜÂ•ΩË°åÁÇ∫ (Á∂†Ëâ≤)ÔºåÈÅøÈñãÂ£ûË°åÁÇ∫ (Á¥ÖËâ≤)ÔºÅ",
          ja: "ËâØ„ÅÑË°å„ÅÑÔºàÁ∑ëÔºâ„ÇíÈõÜ„ÇÅ„Å¶„ÄÅÊÇ™„ÅÑË°å„ÅÑÔºàËµ§Ôºâ„ÇíÈÅø„Åë„Çà„ÅÜÔºÅ",
        },
        win: { en: "You are a Super Citizen!", zh: "‰Ω†ÊòØË∂ÖÁ¥öÂ•ΩÂ∏ÇÊ∞ëÔºÅ" },
        lose: { en: "Oh no! Be careful!", zh: "ÂìéÂëÄÔºÅË¶ÅÂ∞èÂøÉÔºÅ" },
        restart: { en: "Try Again", zh: "ÂÜçË©¶‰∏ÄÊ¨°" },
        score: { en: "Score", zh: "ÂàÜÊï∏" },
      };

      // 10x10 Grid
      const GRID_W = 10;
      const GRID_H = 10;

      // Items
      const items = [
        { x: 2, y: 1, type: "bad", icon: "üóëÔ∏è" }, // Littering
        { x: 5, y: 2, type: "good", icon: "ü§ù" }, // Helping
        { x: 8, y: 3, type: "bad", icon: "üëä" }, // Fighting
        { x: 3, y: 5, type: "good", icon: "üßπ" }, // Cleaning
        { x: 6, y: 6, type: "bad", icon: "üó£Ô∏è" }, // Shouting
        { x: 1, y: 7, type: "good", icon: "üëµ" }, // Respect
        { x: 7, y: 8, type: "good", icon: "üö∂" }, // Queueing
        { x: 9, y: 9, type: "goal", icon: "üè´" },
      ];

      // Walls for Maze effect (simplified)
      const walls = [
        "1,1",
        "1,2",
        "3,1",
        "3,3",
        "3,4",
        "5,5",
        "5,6",
        "7,1",
        "7,2",
        "8,5",
        "2,6",
        "4,8",
        "6,8",
      ];

      function App() {
        const [lang, setLang] = useState("zh");
        const [pos, setPos] = useState({ x: 0, y: 0 });
        const [score, setScore] = useState(0);
        const [collected, setCollected] = useState([]);
        const [status, setStatus] = useState("playing"); // playing, win, lose

        const getText = (key) => t[key][lang] || t[key]["en"];

        const move = (dx, dy) => {
          if (status !== "playing") return;
          const nx = pos.x + dx;
          const ny = pos.y + dy;

          // Bounds
          if (nx < 0 || nx >= GRID_W || ny < 0 || ny >= GRID_H) return;
          // Walls
          if (walls.includes(`${nx},${ny}`)) return;

          setPos({ x: nx, y: ny });
          checkItem(nx, ny);
        };

        const checkItem = (x, y) => {
          const item = items.find((i) => i.x === x && i.y === y);
          if (item) {
            if (item.type === "goal") {
              setStatus("win");
            } else if (!collected.includes(`${x},${y}`)) {
              if (item.type === "good") {
                setScore((s) => s + 100);
                setCollected((prev) => [...prev, `${x},${y}`]);
              } else if (item.type === "bad") {
                setScore((s) => Math.max(0, s - 50));
                // Shake effect?
                // Simple "Lose" condition for strictness? Let's just deduct score.
              }
            }
          }
        };

        const restart = () => {
          setPos({ x: 0, y: 0 });
          setScore(0);
          setCollected([]);
          setStatus("playing");
        };

        return (
          <div className="min-h-screen p-4 flex flex-col items-center">
            <LanguageSelector lang={lang} setLang={setLang} />
            <h1 className="text-4xl font-black text-purple-900 mb-2 mt-4 drop-shadow-sm text-center">
              üèôÔ∏è {getText("title")}
            </h1>
            <p className="font-bold text-purple-800 mb-4 text-center text-sm md:text-base">
              {getText("instruction")}
            </p>
            <div className="font-black text-2xl text-white bg-purple-500 px-6 py-2 rounded-full mb-4 shadow">
              {getText("score")}: {score}
            </div>

            {/* Grid Area */}
            <div className="relative bg-white p-2 rounded-xl shadow-2xl border-4 border-purple-300">
              <div
                className="grid gap-1"
                style={{
                  gridTemplateColumns: `repeat(${GRID_W}, minmax(0, 1fr))`,
                  width: "min(90vw, 400px)",
                  height: "min(90vw, 400px)",
                }}
              >
                {Array.from({ length: GRID_H * GRID_W }).map((_, i) => {
                  const x = i % GRID_W;
                  const y = Math.floor(i / GRID_W);
                  const isWall = walls.includes(`${x},${y}`);
                  const item = items.find((it) => it.x === x && it.y === y);
                  const isCollected = collected.includes(`${x},${y}`);

                  return (
                    <div
                      key={i}
                      className={`rounded-md flex items-center justify-center text-xl md:text-2xl ${
                        isWall ? "bg-slate-800" : "bg-purple-50"
                      }`}
                    >
                      {item && !isCollected && item.type !== "goal" && (
                        <span>{item.icon}</span>
                      )}
                      {item && item.type === "goal" && <span>{item.icon}</span>}
                    </div>
                  );
                })}
              </div>

              {/* Character Overlay */}
              <motion.div className="absolute top-2 left-2 w-[calc(100%-16px)] h-[calc(100%-16px)] pointer-events-none">
                <motion.div
                  className="absolute text-2xl md:text-3xl flex items-center justify-center z-10"
                  animate={{
                    left: `${(pos.x / GRID_W) * 100}%`,
                    top: `${(pos.y / GRID_H) * 100}%`,
                    width: `${100 / GRID_W}%`,
                    height: `${100 / GRID_H}%`,
                  }}
                  transition={{ type: "spring", stiffness: 300, damping: 30 }}
                >
                  üßí
                </motion.div>
              </motion.div>

              {status === "win" && (
                <div className="absolute inset-0 bg-white/90 flex flex-col items-center justify-center rounded-xl z-20">
                  <div className="text-6xl mb-4">üèÜ</div>
                  <h2 className="text-2xl font-black text-purple-800 mb-4">
                    {getText("win")}
                  </h2>
                  <button
                    onClick={restart}
                    className="bg-purple-500 text-white px-6 py-2 rounded-full font-bold shadow"
                  >
                    {getText("restart")}
                  </button>
                </div>
              )}
            </div>

            {/* D-Pad controls for Mobile */}
            <div className="grid grid-cols-3 gap-2 mt-8 w-48">
              <div></div>
              <button
                onClick={() => move(0, -1)}
                className="bg-purple-500 text-white p-4 rounded-xl shadow-lg active:bg-purple-600 text-2xl"
              >
                ‚¨ÜÔ∏è
              </button>
              <div></div>
              <button
                onClick={() => move(-1, 0)}
                className="bg-purple-500 text-white p-4 rounded-xl shadow-lg active:bg-purple-600 text-2xl"
              >
                ‚¨ÖÔ∏è
              </button>
              <div className="flex items-center justify-center font-bold text-purple-300">
                KEYS
              </div>
              <button
                onClick={() => move(1, 0)}
                className="bg-purple-500 text-white p-4 rounded-xl shadow-lg active:bg-purple-600 text-2xl"
              >
                ‚û°Ô∏è
              </button>
              <div></div>
              <button
                onClick={() => move(0, 1)}
                className="bg-purple-500 text-white p-4 rounded-xl shadow-lg active:bg-purple-600 text-2xl"
              >
                ‚¨áÔ∏è
              </button>
              <div></div>
            </div>
          </div>
        );
      }
      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
