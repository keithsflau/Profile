<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>General Studies - Water Filtration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="../../common/i18n.js"></script>
    <style>
      body {
        font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
        background: #ecfeff;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect } = React;
      const { motion } = window.Motion;
      const { LanguageSelector, get } = window.MathI18n;

      const t = {
        title: {
          en: "Water Filter Builder",
          zh: "æ¿¾æ°´å™¨å»ºé€ è€…",
          ja: "æµ„æ°´å™¨ãƒ“ãƒ«ãƒ€ãƒ¼",
          ko: "ì •ìˆ˜ê¸° ë§Œë“¤ê¸°",
          es: "Constructor de filtros de agua",
          de: "Wasserfilter-Bauer",
          fi: "Vesisuodattimen rakentaja",
          fr: "Constructeur de filtre Ã  eau",
          ar: "Ø¨Ø§Ù†ÙŠ ØªØµÙÙŠØ© Ø§Ù„Ù…ÙŠØ§Ù‡",
          it: "Costruttore Filtro Acqua",
        },
        instruction: {
          en: "Build the filter layers from Coarse to Fine!",
          zh: "ç”±ç²—åˆ°ç´°å»ºç«‹éŽæ¿¾å±¤ï¼",
          ja: "ç²—ã„ã‚‚ã®ã‹ã‚‰ç´°ã‹ã„ã‚‚ã®ã¸ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å±¤ã‚’ä½œã‚ã†ï¼",
          ko: "ê±°ì¹œ ê²ƒë¶€í„° ê³ ìš´ ê²ƒê¹Œì§€ í•„í„° ì¸µì„ ë§Œë“œì„¸ìš”!",
          es: "Â¡Construye las capas de filtro de grueso a fino!",
          de: "Baue die Filterschichten von grob nach fein auf!",
          fi: "Rakenna suodatinsarjat karkeasta hienoon!",
          fr: "Construisez les couches filtrantes du grossier au fin !",
          ar: "Ø§Ø¨Ù†Ù Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ù…Ø±Ø´Ø­ Ù…Ù† Ø§Ù„Ø®Ø´Ù† Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø§Ø¹Ù…!",
          it: "Costruisci gli strati del filtro da Grossolano a Fine!",
        },
        gravel: {
          en: "Gravel (Large)",
          zh: "ç¤«çŸ³ (å¤§)",
          ja: "ç ‚åˆ© (å¤§)",
          ko: "ìžê°ˆ (ì´ë¬¼ì§ˆ ì œê±°)",
          es: "Grava (Grande)",
          de: "Kies (GroÃŸ)",
          fi: "Sora (Suuri)",
          fr: "Gravier (Grand)",
          ar: "Ø­ØµÙ‰ (ÙƒØ¨ÙŠØ±)",
          it: "Ghiaia (Grande)",
        },
        sand: {
          en: "Sand (Fine)",
          zh: "æ²™ (ç´°)",
          ja: "ç ‚ (å°)",
          ko: "ëª¨ëž˜ (ë¯¸ì„¸ ë¬¼ì§ˆ ì œê±°)",
          es: "Arena (Fina)",
          de: "Sand (Fein)",
          fi: "Hiekka (Hieno)",
          fr: "Sable (Fin)",
          ar: "Ø±Ù…Ù„ (Ù†Ø§Ø¹Ù…)",
          it: "Sabbia (Fine)",
        },
        charcoal: {
          en: "Charcoal (Chemicals)",
          zh: "æ´»æ€§ç¢³ (åŒ–å­¸ç‰©è³ª)",
          ja: "æœ¨ç‚­ (åŒ–å­¦ç‰©è³ª)",
          ko: "ìˆ¯ (í™”í•™ë¬¼ì§ˆ í¡ì°©)",
          es: "CarbÃ³n (QuÃ­micos)",
          de: "Kohle (Chemikalien)",
          fi: "Hiili (Kemikaalit)",
          fr: "Charbon (Chimiques)",
          ar: "ÙØ­Ù… (Ù…ÙˆØ§Ø¯ ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©)",
          it: "Carbone (Chimici)",
        },
        cotton: {
          en: "Cotton (Base)",
          zh: "æ£‰èŠ± (åº•å±¤)",
          ja: "ç¶¿ (ãƒ™ãƒ¼ã‚¹)",
          ko: "ì†œ (ë§ˆì§€ë§‰ ì—¬ê³¼)",
          es: "AlgodÃ³n (Base)",
          de: "Baumwolle (Basis)",
          fi: "Puuvilla (Pohja)",
          fr: "Coton (Base)",
          ar: "Ù‚Ø·Ù† (Ù‚Ø§Ø¹Ø¯Ø©)",
          it: "Cotone (Base)",
        },
        pour: {
          en: "Pour Water",
          zh: "å€’æ°´",
          ja: "æ°´ã‚’æ³¨ã",
          ko: "ë¬¼ ë¶€ê¸°",
          es: "Verter agua",
          de: "Wasser gieÃŸen",
          fi: "Kaada vettÃ¤",
          fr: "Verser l'eau",
          ar: "ØµØ¨ Ø§Ù„Ù…Ø§Ø¡",
          it: "Versa Acqua",
        },
        reset: {
          en: "Reset",
          zh: "é‡ç½®",
          ja: "ãƒªã‚»ãƒƒãƒˆ",
          ko: "ì´ˆê¸°í™”",
          es: "Reiniciar",
          de: "ZurÃ¼cksetzen",
          fi: "Nollaa",
          fr: "RÃ©initialiser",
          ar: "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†",
          it: "Ripristina",
        },
        result_clean: {
          en: "Clean Water!",
          zh: "ä¹¾æ·¨çš„æ°´ï¼",
          ja: "ãã‚Œã„ãªæ°´ï¼",
          ko: "ê¹¨ë—í•œ ë¬¼!",
          es: "Â¡Agua limpia!",
          de: "Sauberes Wasser!",
          fi: "Puhdasta vettÃ¤!",
          fr: "Eau propre !",
          ar: "Ù…Ø§Ø¡ Ù†Ø¸ÙŠÙ!",
          it: "Acqua Pulita!",
        },
        result_dirty: {
          en: "Still Dirty...",
          zh: "ä»ç„¶å¾ˆé«’...",
          ja: "ã¾ã æ±šã‚Œã¦ã„ã‚‹...",
          ko: "ì•„ì§ ë”ëŸ¬ì›€...",
          es: "TodavÃ­a sucio...",
          de: "Noch schmutzig...",
          fi: "VielÃ¤ likainen...",
          fr: "Encore sale...",
          ar: "Ù„Ø§ ÙŠØ²Ø§Ù„ Ù‚Ø°Ø±Ø§...",
          it: "Ancora Sporco...",
        },
      };

      const materials = [
        { id: "gravel", color: "bg-stone-500", texture: "ðŸª¨" },
        { id: "sand", color: "bg-yellow-200", texture: "âˆ´" },
        { id: "charcoal", color: "bg-gray-800", texture: "â¬›" },
        { id: "cotton", color: "bg-white", texture: "â˜ï¸" },
      ];

      function App() {
        const [lang, setLang] = useState("zh");
        const [layers, setLayers] = useState([]); // Bottom to Top visually? Usually build upwards.
        const [filtering, setFiltering] = useState(false);
        const [result, setResult] = useState(null);

        const getText = (key) => t[key][lang] || t[key]["en"];

        const addLayer = (mat) => {
          if (layers.length < 4 && !filtering) {
            setLayers([...layers, mat]); // Stack on top
          }
        };

        const reset = () => {
          setLayers([]);
          setFiltering(false);
          setResult(null);
        };

        const pour = () => {
          if (layers.length === 0) return;
          setFiltering(true);

          // Correct order (Top down): Gravel -> Sand -> Charcoal -> Cotton.
          // User stacks Bottom Up? Or adds to Top?
          // Stack visual: Oldest at Bottom.
          // If user adds: Cotton, then Charcoal, then Sand, then Gravel.
          // Array: [Cotton, Charcoal, Sand, Gravel]
          // Correct order check:
          // Bottom (index 0) = Cotton
          // Index 1 = Charcoal
          // Index 2 = Sand
          // Index 3 = Gravel

          // Check sequence
          const expectedOrder = ["cotton", "charcoal", "sand", "gravel"]; // Ideal

          // Flexible check: Cotton at bottom is crucial. Gravel at top is good.
          // Just check exact match for "Perfect" clean.

          setTimeout(() => {
            const currentIds = layers.map((l) => l.id);
            const isPerfect =
              JSON.stringify(currentIds) === JSON.stringify(expectedOrder);
            setResult(isPerfect ? "result_clean" : "result_dirty");
            setFiltering(false);
          }, 2000);
        };

        return (
          <div className="min-h-screen flex flex-col items-center p-4">
            <LanguageSelector lang={lang} setLang={setLang} />
            <h1 className="text-4xl font-bold mb-8 text-cyan-700">
              {getText("title")}
            </h1>

            <div className="flex flex-col md:flex-row gap-12 items-end justify-center w-full max-w-4xl">
              {/* Builder Area */}
              <div className="relative w-48 h-[400px] flex flex-col items-center">
                {/* Bottle Spout */}
                <div className="w-16 h-8 bg-cyan-100 border-x-4 border-cyan-300"></div>

                {/* Bottle Body (Inverted) */}
                <div className="w-48 h-[300px] bg-cyan-50/50 border-4 border-cyan-300 rounded-b-3xl border-t-0 flex flex-col-reverse overflow-hidden relative">
                  {layers.map((l, i) => (
                    <div
                      key={i}
                      className={`w-full h-1/4 ${l.color} flex items-center justify-center text-2xl border-t border-black/10`}
                    >
                      {l.texture} {getText(l.id).split(" ")[0]}
                    </div>
                  ))}
                  {layers.length === 0 && (
                    <div className="absolute inset-0 flex items-center justify-center text-cyan-300 font-bold opacity-50">
                      Empty
                    </div>
                  )}
                </div>

                {/* Beaker for clean water */}
                <div className="mt-4 w-32 h-20 border-b-4 border-x-4 border-slate-400 rounded-b-xl relative overflow-hidden">
                  {result === "result_clean" && (
                    <div className="absolute bottom-0 w-full h-16 bg-blue-300 opacity-60 animate-bounce-slow"></div>
                  )}
                  {result === "result_dirty" && (
                    <div className="absolute bottom-0 w-full h-16 bg-yellow-700 opacity-60 animate-bounce-slow"></div>
                  )}
                </div>

                {/* Dirty Water Pouring */}
                {filtering && (
                  <div className="absolute -top-20 left-1/2 -translate-x-1/2 flex flex-col items-center z-20">
                    <div className="text-4xl rotate-45">ðŸ«—</div>
                    <motion.div
                      className="w-4 bg-yellow-700 h-64 opacity-50"
                      initial={{ scaleY: 0 }}
                      animate={{ scaleY: 1 }}
                    ></motion.div>
                  </div>
                )}
              </div>

              {/* Controls */}
              <div className="flex flex-col gap-4">
                <div className="bg-white p-6 rounded-2xl shadow-lg">
                  <h3 className="font-bold text-slate-500 mb-4">
                    {getText("instruction")}
                  </h3>
                  <div className="grid grid-cols-2 gap-4">
                    {materials.map((m) => (
                      <button
                        key={m.id}
                        onClick={() => addLayer(m)}
                        disabled={layers.length >= 4 || filtering}
                        className={`p-4 rounded-xl font-bold flex flex-col items-center gap-2 border-2 text-sm transition-transform active:scale-95 hover:bg-slate-50
                                  ${
                                    layers.length >= 4
                                      ? "opacity-50 cursor-not-allowed"
                                      : "border-slate-200"
                                  }
                               `}
                      >
                        <div className="text-3xl">{m.texture}</div>
                        <div>{getText(m.id)}</div>
                      </button>
                    ))}
                  </div>
                </div>

                <div className="flex gap-4">
                  <button
                    onClick={pour}
                    disabled={filtering || layers.length === 0}
                    className="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-xl shadow-lg disabled:opacity-50"
                  >
                    {getText("pour")}
                  </button>
                  <button
                    onClick={reset}
                    className="bg-slate-500 hover:bg-slate-400 text-white font-bold py-3 px-6 rounded-xl shadow-lg"
                  >
                    {getText("reset")}
                  </button>
                </div>

                {result && (
                  <div
                    className={`text-center font-black text-2xl px-4 py-2 rounded-xl animate-bounce ${
                      result === "result_clean"
                        ? "bg-green-100 text-green-600"
                        : "bg-red-100 text-red-600"
                    }`}
                  >
                    {getText(result)}
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
