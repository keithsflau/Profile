<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>General Studies - Pitch and Volume</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="../../common/i18n.js"></script>
    <style>
      body {
        font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
        background: #27272a;
        color: white;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      const { motion } = window.Motion;
      const { LanguageSelector, get } = window.MathI18n;

      const t = {
        title: {
          en: "Pitch & Volume Lab",
          zh: "音調與音量實驗室",
          ja: "ピッチと音量の実験室",
          ko: "음조 및 음량 실험실",
          es: "Laboratorio de tono y volumen",
          de: "Tonhöhen- & Lautstärke-Labor",
          fi: "Äänenkorkeus- ja voimakkuuslaboratorio",
          fr: "Laboratoire de hauteur et de volume",
          ar: "مختبر النغمة ومستوى الصوت",
          it: "Laboratorio Tono e Volume",
        },
        instruction: {
          en: "Adjust Pitch (Frequency) and Volume (Amplitude).",
          zh: "調整音調 (頻率) 和音量 (振幅)。",
          ja: "ピッチ（周波数）と音量（振幅）を調整します。",
          ko: "음조(주파수)와 음량(진폭)을 조정하세요.",
          es: "Ajustar tono (frecuencia) y volumen (amplitud).",
          de: "Tonhöhe (Frequenz) und Lautstärke (Amplitude) anpassen.",
          fi: "Säädä äänenkorkeutta (taajuus) ja voimakkuutta (amplitudi).",
          fr: "Réglez la hauteur (fréquence) et le volume (amplitude).",
          ar: "اضبط النغمة (التردد) ومستوى الصوت (السعة).",
          it: "Regola Tono (Frequenza) e Volume (Ampiezza).",
        },
        pitch: {
          en: "Pitch (High/Low)",
          zh: "音調 (高/低)",
          ja: "ピッチ (高/低)",
          ko: "음조 (높음/낮음)",
          es: "Tono (Alto/Bajo)",
          de: "Tonhöhe (Hoch/Tief)",
          fi: "Äänenkorkeus (Korkea/Matala)",
          fr: "Hauteur (Haut/Bas)",
          ar: "نغمة (عالية/منخفضة)",
          it: "Tono (Alto/Basso)",
        },
        volume: {
          en: "Volume (Loud/Soft)",
          zh: "音量 (大/小)",
          ja: "音量 (大/小)",
          ko: "음량 (크게/작게)",
          es: "Volumen (Fuerte/Suave)",
          de: "Lautstärke (Laut/Leise)",
          fi: "Voimakkuus (Kova/Pehmeä)",
          fr: "Volume (Fort/Doux)",
          ar: "مستوى الصوت (عال/منخفض)",
          it: "Volume (Forte/Piano)",
        },
        play: {
          en: "Play Sound",
          zh: "播放聲音",
          ja: "音を再生",
          ko: "소리 재생",
          es: "Reproducir sonido",
          de: "Ton abspielen",
          fi: "Toista ääni",
          fr: "Jouer le son",
          ar: "تشغيل الصوت",
          it: "Riproduci Suono",
        },
      };

      function App() {
        const [lang, setLang] = useState("zh");
        const [pitch, setPitch] = useState(50);
        const [volume, setVolume] = useState(50);
        const [playing, setPlaying] = useState(false);
        const oscillatorRef = useRef(null);
        const gainNodeRef = useRef(null);
        const audioCtxRef = useRef(null);

        const getText = (key) => t[key][lang] || t[key]["en"];

        const startSound = () => {
          if (!audioCtxRef.current) {
            audioCtxRef.current = new (window.AudioContext ||
              window.webkitAudioContext)();
          }

          if (playing) {
            stopSound();
            return;
          }

          const ctx = audioCtxRef.current;
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();

          // Freq mapping: 50 -> 440Hz. Range 200 - 800
          const freq = 200 + (pitch / 100) * 800;
          osc.frequency.value = freq;

          // Gain mapping: 0 -> 0. 100 -> 1.
          gain.gain.value = volume / 100;

          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start();

          oscillatorRef.current = osc;
          gainNodeRef.current = gain;
          setPlaying(true);
        };

        const stopSound = () => {
          if (oscillatorRef.current) {
            oscillatorRef.current.stop();
            oscillatorRef.current.disconnect();
            oscillatorRef.current = null;
          }
          setPlaying(false);
        };

        // Update live
        useEffect(() => {
          if (playing && oscillatorRef.current && gainNodeRef.current) {
            const freq = 200 + (pitch / 100) * 800;
            oscillatorRef.current.frequency.setValueAtTime(
              freq,
              audioCtxRef.current.currentTime
            );

            const vol = volume / 100;
            gainNodeRef.current.gain.setValueAtTime(
              vol,
              audioCtxRef.current.currentTime
            );
          }
        }, [pitch, volume, playing]);

        // Cleanup
        useEffect(() => {
          return () => {
            if (oscillatorRef.current) oscillatorRef.current.stop();
            if (audioCtxRef.current) audioCtxRef.current.close();
          };
        }, []);

        return (
          <div className="min-h-screen flex flex-col items-center p-4">
            <LanguageSelector lang={lang} setLang={setLang} />
            <h1 className="text-4xl font-bold mb-8 text-green-400">
              {getText("title")}
            </h1>

            <div className="w-full max-w-2xl bg-zinc-800 p-8 rounded-3xl shadow-2xl border border-zinc-700">
              {/* Wave Visualization */}
              <div className="h-40 bg-black rounded-xl mb-8 flex items-center justify-center overflow-hidden relative border border-zinc-600">
                {/* Simplified wave visualization - just SVG sin wave */}
                <svg
                  width="100%"
                  height="100%"
                  viewBox="0 0 400 100"
                  preserveAspectRatio="none"
                >
                  <motion.path
                    d={`M0,50 Q25,${
                      50 - volume / 2
                    } 50,50 T100,50 T150,50 T200,50 T250,50 T300,50 T350,50 T400,50`}
                    stroke="#4ade80"
                    strokeWidth="4"
                    fill="none"
                    animate={{
                      d: [
                        `M0,50 Q${50 - pitch / 3},${50 - volume / 2} ${
                          100 - pitch / 1.5
                        },50 T${200 - pitch * 1.3},50 T${
                          300 - pitch * 2
                        },50 T400,50`,
                        `M0,50 Q${50 - pitch / 3},${50 + volume / 2} ${
                          100 - pitch / 1.5
                        },50 T${200 - pitch * 1.3},50 T${
                          300 - pitch * 2
                        },50 T400,50`,
                        `M0,50 Q${50 - pitch / 3},${50 - volume / 2} ${
                          100 - pitch / 1.5
                        },50 T${200 - pitch * 1.3},50 T${
                          300 - pitch * 2
                        },50 T400,50`,
                      ],
                    }}
                    transition={{
                      repeat: Infinity,
                      duration: playing ? (100 - pitch) / 200 + 0.1 : 0,
                      ease: "linear",
                    }}
                  />
                </svg>
                {!playing && (
                  <div className="absolute text-slate-500">Press Play</div>
                )}
              </div>

              {/* Pitch Control */}
              <div className="mb-6">
                <div className="flex justify-between font-bold text-slate-300 mb-2">
                  <span>{getText("pitch")}</span>
                  <span className="text-green-400">{pitch}%</span>
                </div>
                <input
                  type="range"
                  min="0"
                  max="100"
                  value={pitch}
                  onChange={(e) => setPitch(Number(e.target.value))}
                  className="w-full h-4 bg-zinc-600 rounded-lg appearance-none cursor-pointer accent-green-500"
                />
                <div className="flex justify-between text-xs text-slate-500 mt-1">
                  <span>Low (Deep)</span>
                  <span>High (Squeaky)</span>
                </div>
              </div>

              {/* Volume Control */}
              <div className="mb-8">
                <div className="flex justify-between font-bold text-slate-300 mb-2">
                  <span>{getText("volume")}</span>
                  <span className="text-green-400">{volume}%</span>
                </div>
                <input
                  type="range"
                  min="0"
                  max="100"
                  value={volume}
                  onChange={(e) => setVolume(Number(e.target.value))}
                  className="w-full h-4 bg-zinc-600 rounded-lg appearance-none cursor-pointer accent-green-500"
                />
              </div>

              <div className="text-center">
                <button
                  onClick={startSound}
                  className={`px-12 py-4 rounded-full font-black text-2xl shadow-lg transition-transform active:scale-95
                         ${
                           playing
                             ? "bg-red-500 hover:bg-red-600 text-white"
                             : "bg-green-500 hover:bg-green-600 text-black"
                         }
                      `}
                >
                  {playing ? "STOP ■" : getText("play") + " ▶"}
                </button>
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
