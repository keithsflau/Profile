<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°äºŒå¸¸è­˜ï¼šäº¤é€šç‡ˆè™Ÿ | Traffic Lights</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="../../common/i18n.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Fredoka:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Fredoka", "Noto Sans TC", sans-serif;
        background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      const { motion, AnimatePresence } = window.Motion;
      const { LanguageSelector, get } = window.MathI18n;

      const t = {
        title: {
          en: "Traffic Lights",
          zh: "äº¤é€šç‡ˆè™Ÿ",
          ja: "ä¿¡å·æ©Ÿ",
        },
        instruction: {
          en: "Tap to cross ONLY when Green Man is ON!",
          zh: "åªæœ‰ã€Œç¶ å…¬ä»”ã€äº®èµ·æ™‚æ‰æŒ‰ä¸€ä¸‹éé¦¬è·¯ï¼",
          ja: "é’ä¿¡å·ã®æ™‚ã ã‘ã‚¿ãƒƒãƒ—ã—ã¦æ¸¡ã£ã¦ãã ã•ã„ï¼",
        },
        start: { en: "Start Game", zh: "é–‹å§‹éŠæˆ²" },
        redHuman: { en: "Red Man: STOP!", zh: "ç´…å…¬ä»”ï¼šåœï¼" },
        greenHuman: { en: "Green Man: GO!", zh: "ç¶ å…¬ä»”ï¼šè¡Œï¼" },
        blinkHuman: {
          en: "Blinking: DON'T START!",
          zh: "é–ƒå‹•ï¼šä¸å¯é–‹å§‹æ©«éï¼",
        },

        score: { en: "Score", zh: "åˆ†æ•¸" },
        gameover: { en: "Game Over", zh: "éŠæˆ²çµæŸ" },
        safe: { en: "Safe!", zh: "å®‰å…¨ï¼" },
        crash: { en: "Dangerous! Car hit!", zh: "å±éšªï¼è¢«è»Šæ’äº†ï¼" },
        wait: { en: "Be Patient...", zh: "è€å¿ƒç­‰å€™..." },
        restart: { en: "Play Again", zh: "å†ç©ä¸€æ¬¡" },
      };

      function App() {
        const [lang, setLang] = useState("zh");
        const [isPlaying, setIsPlaying] = useState(false);
        const [lightState, setLightState] = useState("red"); // red, green, blink
        const [score, setScore] = useState(0);
        const [msg, setMsg] = useState("");
        const [playerPosition, setPlayerPosition] = useState(0); // 0: Start, 100: End

        const timerRef = useRef(null);
        const blinkCountRef = useRef(0);

        const getText = (key) => t[key][lang] || t[key]["en"];

        // Game Loop for Lights
        useEffect(() => {
          if (!isPlaying) return;

          const cycleLights = async () => {
            setLightState("red");
            await wait(3000 + Math.random() * 2000);
            if (!isPlaying) return;

            setLightState("green");
            await wait(3000 + Math.random() * 3000); // Green duration
            if (!isPlaying) return;

            // Blink
            for (let i = 0; i < 6; i++) {
              if (!isPlaying) return;
              setLightState("blink_on");
              await wait(300);
              setLightState("blink_off");
              await wait(300);
            }
            setLightState("red"); // Loop in effect re-trigger logic? No, need explicit loop.
          };

          // Use a recursive timeout pattern or interval for simplicity? A loop function is better.
          let timeoutId;
          const runLoop = async () => {
            while (isPlaying) {
              setLightState("red");
              await new Promise(
                (r) => (timeoutId = setTimeout(r, 2000 + Math.random() * 2000))
              );

              if (!isPlaying) break;
              setLightState("green");
              await new Promise(
                (r) => (timeoutId = setTimeout(r, 2000 + Math.random() * 3000))
              );

              if (!isPlaying) break;
              // Blink blink
              for (let i = 0; i < 6; i++) {
                setLightState("blink"); // Simplified blink state handling in render
                await new Promise((r) => (timeoutId = setTimeout(r, 250)));
                setLightState("green"); // Quickly toggle for visual, or just use CSS anim
                // Actually let's use a state 'blink' and let CSS handle the flashing? Or manual toggle
              }
              // For Logic: Blink is 'warning'.
              // Let's simplified: Red -> Green -> Blink -> Red
              setLightState("blink");
              await new Promise((r) => (timeoutId = setTimeout(r, 2000)));

              if (!isPlaying) break;
            }
          };
          runLoop();

          return () => clearTimeout(timeoutId);
        }, [isPlaying]);

        const wait = (ms) => new Promise((res) => setTimeout(res, ms));

        const startGame = () => {
          setIsPlaying(true);
          setScore(0);
          setPlayerPosition(0);
          setMsg("");
        };

        const stopGame = () => {
          setIsPlaying(false);
        };

        const handleCross = () => {
          if (!isPlaying) return;

          if (lightState === "green") {
            // Success
            setScore((s) => s + 1);
            setMsg("safe");
            // Animate player across
            setPlayerPosition(100);
            setTimeout(() => {
              setPlayerPosition(0);
              setMsg("");
            }, 500);
          } else if (lightState === "red" || lightState === "blink") {
            // Fail
            setMsg("crash");
            stopGame();
          }
        };

        return (
          <div className="min-h-screen p-4 flex flex-col items-center select-none">
            <LanguageSelector lang={lang} setLang={setLang} />
            <h1 className="text-4xl md:text-5xl font-black text-slate-800 mb-4 mt-8 drop-shadow-sm bg-white/50 px-6 py-2 rounded-full">
              ğŸš¦ {getText("title")}
            </h1>

            {!isPlaying ? (
              <div className="bg-white/90 p-12 rounded-3xl shadow-xl text-center mt-12">
                {msg === "crash" && <div className="text-6xl mb-4">ğŸ’¥ğŸš—</div>}
                <h2 className="text-3xl font-black text-slate-800 mb-6">
                  {msg === "crash"
                    ? getText("gameover")
                    : getText("instruction")}
                </h2>
                {msg === "crash" && (
                  <p className="text-red-600 font-bold text-xl mb-4">
                    {getText("crash")}
                  </p>
                )}

                <p className="text-xl mb-8 font-bold text-slate-600">
                  {getText("score")}: {score}
                </p>
                <button
                  onClick={startGame}
                  className="bg-green-500 text-white px-10 py-4 rounded-full font-black text-xl hover:bg-green-600 shadow-xl border-b-4 border-green-700 active:border-b-0 active:translate-y-1"
                >
                  {msg === "crash" ? getText("restart") : getText("start")}
                </button>
              </div>
            ) : (
              <div className="w-full max-w-lg flex flex-col items-center">
                {/* Traffic Light */}
                <div className="bg-slate-900 p-4 rounded-3xl flex flex-col items-center gap-4 border-8 border-slate-700 shadow-2xl mb-12">
                  <div
                    className={`w-24 h-24 rounded-full border-4 border-slate-600 flex items-center justify-center ${
                      lightState === "red"
                        ? "bg-red-500 shadow-[0_0_30px_red]"
                        : "bg-red-900 opacity-30"
                    }`}
                  >
                    {lightState === "red" && (
                      <motion.div
                        animate={{ scale: [1, 1.1, 1] }}
                        transition={{ repeat: Infinity }}
                        className="text-5xl"
                      >
                        ğŸš¶ğŸš«
                      </motion.div>
                    )}
                  </div>
                  <div
                    className={`w-24 h-24 rounded-full border-4 border-slate-600 flex items-center justify-center ${
                      lightState === "green"
                        ? "bg-green-500 shadow-[0_0_30px_#0f0]"
                        : lightState === "blink"
                        ? "bg-green-500 animate-pulse"
                        : "bg-green-900 opacity-30"
                    }`}
                  >
                    {(lightState === "green" || lightState === "blink") && (
                      <motion.div
                        animate={
                          lightState === "green"
                            ? { x: [-2, 2, -2] }
                            : { opacity: [0, 1, 0] }
                        }
                        transition={{ repeat: Infinity, duration: 0.5 }}
                        className="text-5xl"
                      >
                        ğŸš¶â€â™‚ï¸
                      </motion.div>
                    )}
                  </div>
                </div>

                {/* Status Text */}
                <div className="h-12 mb-4 font-bold text-2xl text-slate-700 text-center">
                  {lightState === "red" && getText("redHuman")}
                  {lightState === "green" && getText("greenHuman")}
                  {lightState === "blink" && getText("blinkHuman")}
                </div>

                {/* Road Scene */}
                <div className="relative w-full h-40 bg-slate-600 rounded-lg overflow-hidden border-y-4 border-white flex flex-col justify-center">
                  {/* Zebra Crossing */}
                  <div className="absolute inset-0 flex justify-evenly">
                    {[...Array(6)].map((_, i) => (
                      <div
                        key={i}
                        className="w-12 h-full bg-white opacity-50 transform -skew-x-12"
                      ></div>
                    ))}
                  </div>

                  {/* Player Character */}
                  <motion.div
                    className="absolute bottom-4 text-6xl z-10"
                    initial={{ left: "10%" }}
                    animate={{ left: playerPosition > 0 ? "90%" : "10%" }}
                    transition={{ duration: 0.5 }}
                  >
                    ğŸƒ
                  </motion.div>

                  {/* Car (only visible if crash) */}
                  {msg === "crash" && (
                    <motion.div
                      initial={{ x: -200 }}
                      animate={{ x: 100 }}
                      className="absolute top-10 left-[10%] text-8xl z-20"
                    >
                      ğŸš—
                    </motion.div>
                  )}
                </div>

                {/* Control Button - BIG TAP AREA */}
                <button
                  onClick={handleCross}
                  className="mt-8 w-full max-w-xs bg-blue-500 text-white py-6 rounded-3xl font-black text-3xl shadow-xl border-b-8 border-blue-700 active:border-b-0 active:translate-y-2 active:bg-blue-600"
                >
                  GO!
                </button>

                <div className="mt-4 font-bold text-slate-500">
                  {getText("score")}: {score}
                </div>
              </div>
            )}
          </div>
        );
      }
      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
