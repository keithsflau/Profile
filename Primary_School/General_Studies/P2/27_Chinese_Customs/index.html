<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Â∞è‰∫åÂ∏∏Ë≠òÔºöÂÇ≥Áµ±Áøí‰øó | Chinese Customs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="../../common/i18n.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Fredoka:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Fredoka", "Noto Sans TC", sans-serif;
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect } = React;
      const { motion, AnimatePresence } = window.Motion;
      const { LanguageSelector, get } = window.MathI18n;

      const t = {
        title: {
          en: "Customs",
          zh: "ÂÇ≥Áµ±Áøí‰øó",
          ja: "‰ºùÁµ±ÁöÑ„Å™ÁøíÊÖ£",
        },
        instruction: {
          en: "What do we do in this festival?",
          zh: "Âú®ÈÄôÂÄãÁØÄÊó•ÊàëÂÄëÊúÉÂÅö‰ªÄÈ∫ºÔºü",
          ja: "„Åì„ÅÆ„ÅäÁ•≠„Çä„Åß„ÅØ‰Ωï„Çí„Åó„Åæ„Åô„ÅãÔºü",
        },
        correct: { en: "Correct!", zh: "Á≠îÂ∞ç‰∫ÜÔºÅ" },
        wrong: { en: "Try Again", zh: "ÂÜçË©¶‰∏ÄÊ¨°" },

        cny: { en: "Lunar New Year", zh: "Ëæ≤ÊõÜÊñ∞Âπ¥" },
        mid: { en: "Mid-Autumn", zh: "‰∏≠ÁßãÁØÄ" },
        dragon: { en: "Dragon Boat", zh: "Á´ØÂçàÁØÄ" },
        grave: { en: "Ching Ming", zh: "Ê∏ÖÊòéÁØÄ" },

        redpacket: { en: "Red Packet", zh: "Ê¥æÂà©ÊòØ" },
        lantern: { en: "Lanterns", zh: "Áé©ÁáàÁ±†" },
        boat: { en: "Dragon Boat Race", zh: "ÊâíÈæçËàü" },
        sweep: { en: "Sweep Graves", zh: "ÊéÉÂ¢ì" },

        candy: { en: "Candy Box", zh: "ÂÖ®Áõí" },
        mooncake: { en: "Mooncake", zh: "ÂêÉÊúàÈ§Ö" },
        dumpling: { en: "Rice Dumpling", zh: "ÂêÉÁ≤ΩÂ≠ê" },

        score: { en: "Score", zh: "ÂàÜÊï∏" },
        next: { en: "Next", zh: "‰∏ã‰∏ÄÈ°å" },
        completed: { en: "Festival Master!", zh: "ÁØÄÊó•Â∞èÈÅî‰∫∫ÔºÅ" },
        restart: { en: "Play Again", zh: "ÂÜçÁé©‰∏ÄÊ¨°" },
      };

      const festivals = [
        { id: "cny", icon: "üßß", items: ["redpacket", "candy"] },
        { id: "mid", icon: "üåï", items: ["lantern", "mooncake"] },
        { id: "dragon", icon: "üêâ", items: ["boat", "dumpling"] },
        { id: "grave", icon: "‚õ∞Ô∏è", items: ["sweep"] },
      ];

      const allItems = [
        { id: "redpacket", icon: "üßß" },
        { id: "lantern", icon: "üèÆ" },
        { id: "boat", icon: "üö£" },
        { id: "sweep", icon: "üßπ" },
        { id: "candy", icon: "üç¨" },
        { id: "mooncake", icon: "ü•Æ" },
        { id: "dumpling", icon: "üçô" },
      ];

      function App() {
        const [lang, setLang] = useState("zh");
        const [qIdx, setQIdx] = useState(0);
        const [score, setScore] = useState(0);
        const [shuffledOptions, setShuffledOptions] = useState([]);
        const [feedback, setFeedback] = useState(null);

        const getText = (key) => t[key][lang] || t[key]["en"];
        const currentFestival = festivals[qIdx];

        useEffect(() => {
          if (currentFestival) {
            // Prepare options: Corrext Ones + Some Distractors
            const correctItems = allItems.filter((i) =>
              currentFestival.items.includes(i.id)
            );
            const distractors = allItems
              .filter((i) => !currentFestival.items.includes(i.id))
              .sort(() => Math.random() - 0.5)
              .slice(0, 2);

            setShuffledOptions(
              [...correctItems, ...distractors].sort(() => Math.random() - 0.5)
            );
            setFeedback(null);
          }
        }, [qIdx]);

        const handleSelect = (item) => {
          if (feedback) return;
          if (currentFestival.items.includes(item.id)) {
            setFeedback("correct");
            setScore((s) => s + 10);
          } else {
            setFeedback("wrong");
          }
        };

        const next = () => {
          if (qIdx < festivals.length - 1) setQIdx(qIdx + 1);
          else setQIdx(-1); // Finished
        };

        const restart = () => {
          setQIdx(0);
          setScore(0);
        };

        return (
          <div className="min-h-screen p-4 flex flex-col items-center">
            <LanguageSelector lang={lang} setLang={setLang} />
            <h1 className="text-4xl md:text-5xl font-black text-red-800 mb-4 mt-8 drop-shadow-sm bg-white/50 px-6 py-2 rounded-full">
              üèÆ {getText("title")}
            </h1>

            {qIdx !== -1 && currentFestival ? (
              <div className="w-full max-w-lg flex flex-col items-center">
                <div className="font-bold text-red-700 mb-4 bg-white px-4 py-1 rounded-full shadow">
                  {getText("score")}: {score}
                </div>

                <div className="bg-red-50 p-8 rounded-3xl border-4 border-red-200 text-center mb-8 w-full shadow-lg">
                  <div className="text-8xl mb-4 animate-bounce-slow">
                    {currentFestival.icon}
                  </div>
                  <h2 className="text-3xl font-black text-red-900">
                    {getText(currentFestival.id)}
                  </h2>
                  <p className="mt-4 text-slate-500 font-bold">
                    {getText("instruction")}
                  </p>
                </div>

                <div className="grid grid-cols-2 gap-4 w-full">
                  {shuffledOptions.map((opt, i) => (
                    <button
                      key={i}
                      onClick={() => handleSelect(opt)}
                      disabled={!!feedback}
                      className="bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all flex flex-col items-center border-b-4 border-slate-200 active:border-b-0 active:translate-y-1"
                    >
                      <span className="text-5xl mb-2">{opt.icon}</span>
                      <span className="font-bold text-slate-700">
                        {getText(opt.id)}
                      </span>
                    </button>
                  ))}
                </div>

                {feedback && (
                  <motion.div
                    initial={{ scale: 0 }}
                    animate={{ scale: 1 }}
                    className={`mt-6 p-4 rounded-xl font-black text-2xl text-center w-full shadow-lg ${
                      feedback === "correct"
                        ? "bg-green-100 text-green-700"
                        : "bg-red-100 text-red-600"
                    }`}
                  >
                    {getText(feedback)}
                    {feedback === "correct" && (
                      <div className="mt-2">
                        <button
                          onClick={next}
                          className="bg-green-600 text-white px-8 py-2 rounded-full text-lg shadow"
                        >
                          {getText("next")} ‚û°Ô∏è
                        </button>
                      </div>
                    )}
                  </motion.div>
                )}
              </div>
            ) : (
              <div className="bg-white/90 p-12 rounded-3xl shadow-xl text-center mt-12">
                <div className="text-8xl mb-4">üèÜ</div>
                <h2 className="text-3xl font-black text-red-800 mb-6">
                  {getText("completed")}
                </h2>
                <p className="text-xl mb-8 font-bold text-slate-600">
                  {getText("score")}: {score}
                </p>
                <button
                  onClick={restart}
                  className="bg-red-600 text-white px-10 py-4 rounded-full font-black text-xl hover:bg-red-700 shadow-xl"
                >
                  {getText("restart")} üîÑ
                </button>
              </div>
            )}
          </div>
        );
      }
      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
