<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Active English Oral Tutor</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Outfit", "sans-serif"],
            },
            keyframes: {
              "bounce-slight": {
                "0%, 100%": { transform: "translateY(-2%)" },
                "50%": { transform: "translateY(0)" },
              },
              "slide-up": {
                "0%": { opacity: "0", transform: "translateY(20px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
              "pulse-slow": {
                "0%, 100%": { opacity: "1" },
                "50%": { opacity: "0.8" },
              },
            },
            animation: {
              "bounce-slight": "bounce-slight 3s infinite ease-in-out",
              "slide-up": "slide-up 0.4s ease-out forwards",
              "pulse-slow": "pulse-slow 3s infinite",
            },
          },
        },
      };
    </script>
    <style>
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
      }

      .glass-panel {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 h-screen flex flex-col text-slate-800 overflow-hidden relative"
  >
    <!-- Decorative Background Shapes -->
    <div
      class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none"
    >
      <div
        class="absolute top-[-5%] left-[-5%] w-64 h-64 bg-blue-300/20 rounded-full blur-3xl animate-bounce-slight"
      ></div>
      <div
        class="absolute bottom-[-5%] right-[-5%] w-80 h-80 bg-purple-300/20 rounded-full blur-3xl animate-bounce-slight"
        style="animation-delay: 1.5s"
      ></div>
    </div>

    <!-- Header -->
    <header class="glass-panel sticky top-0 z-50 px-4 py-3 shadow-sm">
      <div class="max-w-3xl mx-auto w-full flex flex-col gap-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div
              class="bg-gradient-to-tr from-blue-600 to-indigo-600 text-white w-10 h-10 rounded-xl flex items-center justify-center shadow-lg shadow-blue-200"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
                />
              </svg>
            </div>
            <div>
              <h1
                class="font-bold text-lg leading-tight bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-indigo-700"
              >
                English Oral Tutor
              </h1>
              <p
                class="text-[10px] font-medium text-slate-500 uppercase tracking-wider"
              >
                Interactive Learning
              </p>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button
              onclick="clearChat()"
              class="p-2 text-slate-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
              title="New Chat"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
            </button>
            <button
              onclick="toggleSettings()"
              class="p-2 text-slate-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
              title="API Settings"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- Settings Panel (Hidden by default) -->
        <div
          id="settingsPanel"
          class="hidden transition-all duration-300 overflow-hidden"
        >
          <div
            class="bg-white/50 rounded-lg p-3 border border-slate-200 space-y-2"
          >
            <div class="relative">
              <input
                type="password"
                id="apiKey"
                class="block w-full pl-3 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white/80 text-sm"
                placeholder="Paste OpenAI API Key (sk-...)"
                onchange="saveKey()"
              />
            </div>
            <details class="text-[10px] text-slate-500">
              <summary class="cursor-pointer hover:text-blue-600 font-medium">
                Where do I find my key?
              </summary>
              <p class="mt-1 pl-2 border-l-2 border-slate-300">
                Go to
                <a
                  href="https://platform.openai.com/api-keys"
                  target="_blank"
                  class="text-blue-600 underline"
                  >OpenAI Platform</a
                >
                > Dashboard > API keys.
              </p>
            </details>
          </div>
        </div>
      </div>
    </header>

    <!-- Chat Area -->
    <div
      id="chatContainer"
      class="flex-1 overflow-y-auto p-4 space-y-6 max-w-3xl mx-auto w-full scroll-smooth"
    >
      <!-- AI Welcome & Suggested Topics -->
      <div class="flex flex-col space-y-4 animate-slide-up">
        <!-- Avatar & Greeting -->
        <div class="flex gap-3">
          <div
            class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white shadow-md flex-shrink-0"
          >
            <span class="text-lg">ü§ñ</span>
          </div>
          <div class="flex flex-col gap-2 max-w-[90%]">
            <div
              class="bg-white border border-slate-100 shadow-sm rounded-2xl rounded-tl-none px-5 py-4 text-slate-700 leading-relaxed"
            >
              <p class="font-bold text-slate-800 mb-1">
                Hello! I'm your English Coach.
              </p>
              <p>
                I'm here to help you practice speaking. Pick a topic below to
                start, or just press the mic and say "Hi"!
              </p>
            </div>
          </div>
        </div>

        <!-- Suggestion Chips - Grid -->
        <div id="topicGrid" class="grid grid-cols-2 gap-3 pl-12 sm:grid-cols-3">
          <button
            onclick="useTopic('Introduce your best friend')"
            class="text-left group bg-white/60 hover:bg-white border border-white hover:border-blue-200 p-3 rounded-xl shadow-sm hover:shadow-md transition-all duration-200"
          >
            <span
              class="text-2xl mb-1 block group-hover:scale-110 transition-transform origin-left"
              >üë´</span
            >
            <span
              class="text-sm font-semibold text-slate-700 group-hover:text-blue-600"
              >Best Friend</span
            >
          </button>
          <button
            onclick="useTopic('Describe your favorite food')"
            class="text-left group bg-white/60 hover:bg-white border border-white hover:border-orange-200 p-3 rounded-xl shadow-sm hover:shadow-md transition-all duration-200"
          >
            <span
              class="text-2xl mb-1 block group-hover:scale-110 transition-transform origin-left"
              >üçî</span
            >
            <span
              class="text-sm font-semibold text-slate-700 group-hover:text-orange-600"
              >Favorite Food</span
            >
          </button>
          <button
            onclick="useTopic('Talk about your last holiday')"
            class="text-left group bg-white/60 hover:bg-white border border-white hover:border-green-200 p-3 rounded-xl shadow-sm hover:shadow-md transition-all duration-200"
          >
            <span
              class="text-2xl mb-1 block group-hover:scale-110 transition-transform origin-left"
              >‚úàÔ∏è</span
            >
            <span
              class="text-sm font-semibold text-slate-700 group-hover:text-green-600"
              >Travel</span
            >
          </button>
          <button
            onclick="useTopic('What is your hobby?')"
            class="text-left group bg-white/60 hover:bg-white border border-white hover:border-purple-200 p-3 rounded-xl shadow-sm hover:shadow-md transition-all duration-200"
          >
            <span
              class="text-2xl mb-1 block group-hover:scale-110 transition-transform origin-left"
              >üéÆ</span
            >
            <span
              class="text-sm font-semibold text-slate-700 group-hover:text-purple-600"
              >Hobbies</span
            >
          </button>
        </div>
      </div>
    </div>

    <!-- Controls Footer -->
    <div
      class="glass-panel border-t border-slate-200/50 p-6 pb-8 sticky bottom-0 z-40"
    >
      <div class="max-w-md mx-auto flex flex-col items-center gap-4 relative">
        <!-- Status Indicator -->
        <div
          id="statusText"
          class="text-xs font-bold tracking-widest text-slate-400 uppercase transition-colors"
        >
          Ready to Start
        </div>

        <!-- Main Interaction Button -->
        <button
          id="recordBtn"
          onclick="toggleRecording()"
          class="group relative flex items-center justify-center w-full max-w-[280px] h-16 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 active:scale-95 text-white rounded-full shadow-xl shadow-blue-200/50 transition-all duration-300 overflow-hidden"
        >
          <!-- Ripple effect container (visual only) -->
          <div
            class="absolute inset-0 bg-white/0 group-hover:bg-white/10 transition-colors"
          ></div>

          <div class="relative flex items-center gap-3">
            <div
              id="micIconWrapper"
              class="bg-white/20 p-2 rounded-full backdrop-blur-sm transition-transform group-hover:scale-110"
            >
              <span id="btnIcon" class="text-xl">üéôÔ∏è</span>
            </div>
            <span id="btnText" class="font-bold text-lg tracking-wide"
              >Hold to Speak</span
            >
          </div>
        </button>

        <p class="text-[10px] text-slate-400 text-center opacity-60">
          Click to toggle recording ‚Ä¢ Powered by OpenAI
        </p>
      </div>
    </div>

    <script>
      // --- 1. Settings ---
      let recognition;
      let isRecording = false;
      let conversationHistory = [];
      const synth = window.speechSynthesis;
      let settingsOpen = false;

      const SYSTEM_PROMPT = {
        role: "system",
        content: `You are an engaging and energetic spoken English Tutor for a user (likely a student).
            1. Goal: Encourage the user to speak more by asking follow-up questions.
            2. Style: Casual, friendly, and enthusiastic. Use emojis occasionally.
            3. Correction Rule: If the user makes a grammar/vocab mistake, FIRST answer their thought naturally. THEN, nicely point out the better way to say it in a structured "Correction" block at the VERY end.
            4. Length: Keep responses under 40 words unless explaining a concept.`,
      };

      // --- 2. Initialization ---
      window.onload = () => {
        const savedKey = localStorage.getItem("openai_key_chat");
        if (savedKey) {
          document.getElementById("apiKey").value = savedKey;
        } else {
          toggleSettings(); // Auto-open settings if no key
        }

        setupSpeechRecognition();
        conversationHistory.push(SYSTEM_PROMPT);
      };

      function toggleSettings() {
        const panel = document.getElementById("settingsPanel");
        settingsOpen = !settingsOpen;
        if (settingsOpen) {
          panel.classList.remove("hidden");
        } else {
          panel.classList.add("hidden");
        }
      }

      function saveKey() {
        localStorage.setItem(
          "openai_key_chat",
          document.getElementById("apiKey").value
        );
      }

      function clearChat() {
        if (confirm("Start a new conversation session?")) {
          location.reload();
        }
      }

      function useTopic(topicPhrase) {
        // Hide the grid after selection for cleaner UI
        const grid = document.getElementById("topicGrid");
        grid.style.opacity = "0.5";
        grid.style.pointerEvents = "none";

        // Simulate user sending this message
        addUserMessage(topicPhrase);
        fetchAIResponse(topicPhrase);
      }

      // --- 3. Speech Recognition ---
      function setupSpeechRecognition() {
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          document.getElementById("statusText").innerText =
            "Browser Not Supported";
          const btn = document.getElementById("recordBtn");
          btn.disabled = true;
          btn.className =
            "w-full max-w-[280px] h-16 bg-slate-200 text-slate-400 rounded-full flex items-center justify-center font-bold cursor-not-allowed";
          btn.innerText = "Chrome/Edge Required";
          return;
        }
        recognition = new SpeechRecognition();
        recognition.lang = "en-US";
        recognition.interimResults = false;

        recognition.onstart = () => {
          isRecording = true;
          updateBtnState(true);
          document.getElementById("statusText").innerText = "Listening...";
          document.getElementById("statusText").className =
            "text-xs font-bold tracking-widest text-red-500 uppercase animate-pulse";
        };

        recognition.onend = () => {
          isRecording = false;
          updateBtnState(false);
          document.getElementById("statusText").className =
            "text-xs font-bold tracking-widest text-slate-400 uppercase";
        };

        recognition.onresult = (event) => {
          const text = event.results[0][0].transcript;
          document.getElementById("statusText").innerText = "Processing...";
          addUserMessage(text);
          fetchAIResponse(text);
        };

        recognition.onerror = (e) => {
          console.error(e);
          isRecording = false;
          updateBtnState(false);
          document.getElementById("statusText").innerText = "Error - Try Again";
        };
      }

      function toggleRecording() {
        if (isRecording) recognition.stop();
        else recognition.start();
      }

      function updateBtnState(recording) {
        const btn = document.getElementById("recordBtn");
        const btnText = document.getElementById("btnText");
        const btnIcon = document.getElementById("btnIcon");
        const micWrapper = document.getElementById("micIconWrapper");

        if (recording) {
          // Recording State : Valid Red Style
          btn.className =
            "group relative flex items-center justify-center w-full max-w-[280px] h-16 bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-full shadow-[0_0_20px_rgba(239,68,68,0.6)] scale-105 transition-all duration-200 animate-pulse-slow";
          btnText.innerText = "Stop Listening";
          btnIcon.innerText = "üõë";
          micWrapper.className = "bg-white/20 p-2 rounded-full";
        } else {
          // Default State
          btn.className =
            "group relative flex items-center justify-center w-full max-w-[280px] h-16 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 active:scale-95 text-white rounded-full shadow-xl shadow-blue-200/50 transition-all duration-300 overflow-hidden";
          btnText.innerText = "Hold to Speak";
          btnIcon.innerText = "üéôÔ∏è";
          micWrapper.className =
            "bg-white/20 p-2 rounded-full backdrop-blur-sm transition-transform group-hover:scale-110";
          document.getElementById("statusText").innerText = "Ready to Start";
        }
      }

      // --- 4. Chat Interface ---

      function addUserMessage(text) {
        const container = document.getElementById("chatContainer");

        const wrapper = document.createElement("div");
        wrapper.className =
          "flex flex-col space-y-1 self-end max-w-[85%] items-end animate-slide-up";

        wrapper.innerHTML = `
                <div class="bg-gradient-to-br from-blue-600 to-indigo-600 text-white shadow-lg shadow-blue-200 rounded-2xl rounded-tr-none px-5 py-3 text-base leading-relaxed">
                    ${text}
                </div>
            `;

        container.appendChild(wrapper);
        scrollToBottom();
        conversationHistory.push({ role: "user", content: text });
      }

      function addAILoading() {
        const container = document.getElementById("chatContainer");
        const div = document.createElement("div");
        div.id = "current-loading";
        div.className =
          "flex flex-col space-y-1 self-start max-w-[85%] animate-slide-up";

        div.innerHTML = `
                <div class="flex gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white shadow-md flex-shrink-0 text-sm">
                        ...
                    </div>
                    <div class="bg-white border border-slate-100 shadow-sm rounded-2xl rounded-tl-none px-5 py-4 flex items-center gap-1.5 h-[58px]">
                       <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                       <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                       <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                    </div>
                </div>
            `;

        container.appendChild(div);
        scrollToBottom();
      }

      function removeAILoading() {
        const loading = document.getElementById("current-loading");
        if (loading) loading.remove();
      }

      function addAIMessage(text) {
        removeAILoading();
        const container = document.getElementById("chatContainer");

        // Format corrections with a nice designated box
        let formattedText = text.replace(/\n/g, "<br>");
        let correctionHTML = "";

        if (formattedText.includes("Correction:")) {
          const parts = formattedText.split("Correction:");
          formattedText = parts[0].trim();
          const correctionContent = parts[1].trim();

          correctionHTML = `
                    <div class="mt-4 pt-3 border-t border-dashed border-red-200">
                        <div class="flex gap-2 items-start text-red-600 bg-red-50 p-3 rounded-lg">
                            <span class="text-lg mt-[1px]">üí°</span>
                            <div class="flex-1">
                                <span class="uppercase text-[10px] tracking-wider text-red-400 font-bold block mb-1">Learning Tip</span>
                                <span class="text-sm font-medium">${correctionContent}</span>
                            </div>
                        </div>
                    </div>
                `;
        }

        const wrapper = document.createElement("div");
        wrapper.className =
          "flex flex-col space-y-1 self-start max-w-[90%] sm:max-w-[80%] animate-slide-up";

        wrapper.innerHTML = `
                 <div class="flex gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white shadow-md flex-shrink-0">
                        <span class="text-lg">ü§ñ</span>
                    </div>
                    <div class="bg-white border border-slate-100 shadow-md shadow-slate-100/50 rounded-2xl rounded-tl-none px-5 py-4 text-slate-700 text-base leading-relaxed">
                        ${formattedText}
                        ${correctionHTML}
                    </div>
                </div>
            `;

        container.appendChild(wrapper);
        scrollToBottom();
        conversationHistory.push({ role: "assistant", content: text });
        speakText(text);
      }

      async function fetchAIResponse(userText) {
        const apiKey = document.getElementById("apiKey").value;
        if (!apiKey) {
          alert(
            "Please open settings (top right) and enter your OpenAI API Key."
          );
          removeAILoading();
          return;
        }

        addAILoading();

        try {
          const response = await fetch(
            "https://api.openai.com/v1/chat/completions",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${apiKey}`,
              },
              body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: conversationHistory,
                temperature: 0.7,
                max_tokens: 200,
              }),
            }
          );

          const data = await response.json();
          if (data.error) throw new Error(data.error.message);

          const aiText = data.choices[0].message.content;
          addAIMessage(aiText);
          document.getElementById("statusText").innerText = "Your Turn";
          document.getElementById("statusText").className =
            "text-xs font-bold tracking-widest text-blue-500 uppercase";
        } catch (error) {
          removeAILoading();
          alert("Error: " + error.message);
          document.getElementById("statusText").innerText = "Error";
        }
      }

      function speakText(text) {
        synth.cancel();
        // simple text cleanup for speech
        let textToSpeak = text.replace(/Correction:[\s\S]*/i, ""); // Don't speak the correction label rigidly

        // Or speak the whole thing? Let's speak the whole thing but maybe different voice if possible
        // Actually, speaking just the conversational part is more natural.
        // Let's stick to the text.

        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = "en-US";

        const voices = synth.getVoices();
        const preferredVoice = voices.find(
          (v) =>
            v.name.includes("Google US English") || v.name.includes("Samantha")
        );
        if (preferredVoice) utter.voice = preferredVoice;

        utter.rate = 1.0;
        synth.speak(utter);
      }

      function scrollToBottom() {
        setTimeout(() => {
          const container = document.getElementById("chatContainer");
          container.scrollTop = container.scrollHeight;
        }, 100);
      }
    </script>
  
      
      <!-- Footer -->
      <footer class="text-center py-4 text-slate-500 text-sm">
        <p class="italic mb-1">
          But God made the earth by his power; he founded the world by his wisdom and stretched out the heavens by his
          understanding. Jeremiah 10:12
        </p>
        <p class="text-xs mb-1 mt-2">
          „ÄåËÄ∂ÂíåËèØÁî®ËÉΩÂäõÂâµÈÄ†Â§ßÂú∞ÔºåÁî®Êô∫ÊÖßÂª∫Á´ã‰∏ñÁïåÔºåÁî®ËÅ∞ÊòéÈã™ÂºµÁ©πËíº„ÄÇ„Äç ËÄ∂Âà©Á±≥Êõ∏ 10:12
        </p>
        <p class="text-xs mt-2 pt-2 border-t border-slate-300">
          @ 2025 Education Engineering Portfolio | Generated by Gemini Pro 3.0 | Prepared by SF Lau
        </p>
      </footer>
</body>
</html>
